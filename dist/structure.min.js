/*! Structure.js v0.1.0-alpha | (c) 2014 Marius Lundg√•rd | http://mariuslundgard.com/projects/structure/license */
!function(a){var b=a.structure={};b.elementRules={globalAttrs:{accesskey:[],"class":[],contenteditable:[],contextmenu:[],dir:[],draggable:[],dropzone:[],hidden:[],id:[],itemid:[],itemprop:[],itemref:[],itemscope:[],itemtype:[],lang:[],spellcheck:[],style:[],tabindex:[],title:[]},voidElements:["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],html:{allowedChildElements:{head:[],body:[]}},head:{allowedAttrs:{profile:[]},allowedChildElements:{title:[],base:{allowedAttrs:{href:[],target:[]}},link:{allowedAttrs:{crossorigin:[],disabled:[],href:[],hreflang:[],media:[],methods:[],rel:[],sizes:[],target:[],type:[]}},meta:{allowedAttrs:{charset:["utf-8"],content:[],"http-equiv":[],name:[]}},style:{allowedAttrs:{type:[],media:[],scoped:[],title:[],disabled:[]}},script:{allowedAttrs:{async:[],src:[],type:[],defer:[],crossorigin:[]}},noscript:[]}},body:{allowedAttrs:{onafterprint:[]},allowedChildElements:{script:{allowedAttrs:{async:[],src:[],type:[],defer:[],crossorigin:[]}},noscript:[],section:{allowedChildElements:{"#flow":[],flink:[]}},nav:{allowedChildElements:{"#flow":[]}},article:{allowedChildElements:{"#flow":[]}},aside:{allowedChildElements:{"#flow":[]}},h1:{allowedChildElements:{"#phrasing":[]}},h2:{allowedChildElements:{"#phrasing":[]}},h3:{allowedChildElements:{"#phrasing":[]}},h4:{allowedChildElements:{"#phrasing":[]}},h5:{allowedChildElements:{"#phrasing":[]}},h6:{allowedChildElements:{"#phrasing":[]}},header:{allowedChildElements:{"#flow":[]}},footer:{allowedChildElements:{"#flow":[]}},address:[],main:{allowedChildElements:{"#flow":[]}},p:{allowedChildElements:{"#phrasing":[]}},hr:{allowedAttrs:{color:[]}},pre:[],blockquote:{allowedAttrs:{cite:[]}},ol:{allowedChildElements:{li:[]},allowedAttrs:{reversed:[],start:[],type:[]}},ul:{allowedChildElements:{li:[]}},li:{allowedAttrs:{value:[]}},dl:{allowedChildElements:{dd:[],dt:[]},allowedAttrs:{compact:[]}},dt:[],dd:{allowedAttrs:{nowrap:[]}},figure:{allowedChildElements:{"#flow":[],figcaption:[]}},figcaption:[],div:{allowedChildElements:{"#flow":[]}},a:{allowedAttrs:{datafld:[],datasrc:[],download:[],href:[],hreflang:[],media:[],methods:[],ping:[],rel:[],target:[],type:[],urn:[]}},em:[],strong:[],small:[],s:[],cite:[],q:{allowedAttrs:{cite:[]}},dfn:[],abbr:[],data:{allowedAttrs:{value:[]}},time:{allowedAttrs:{datetime:[]}},code:[],"var":[],samp:[],kbd:[],sub:[],sup:[],i:[],b:[],u:[],mark:[],ruby:{allowedChildElements:{"#phrasing":[]}},rt:[],rp:[],bdi:[],bdo:{allowedAttrs:{dir:[]}},span:[],br:{allowedAttrs:{clear:[]}},wbr:[],ins:{allowedAttrs:{cite:[],datetime:[]}},del:{allowedAttrs:{cite:[],datetime:[]}},img:{allowedAttrs:{alt:[],crossorigin:[],height:[],ismap:[],src:[],width:[],usemap:[]}},iframe:{allowedAttrs:{allowfullscreen:[],height:[],mozapp:[],mozbrowser:[],name:[],remote:[],sandbox:[],seamless:[],src:[],srcdoc:[],width:[]}},embed:{allowedAttrs:{height:[],src:[],type:[],width:[]}},object:{allowedChildElements:{param:[],"#transparent":[]},allowedAttrs:{data:[],form:[],height:[],name:[],type:[],width:[]}},param:{allowedAttrs:{name:[],value:[]}},video:{allowedChildElements:{"#transparent":[],source:[],"#flow":[],"#phrasing":[]},allowedAttrs:{autoplay:[],buffered:[],controls:[],crossorigin:[],height:[],loop:[],muted:[],played:[],preload:[],poster:[],src:[],width:[]}},audio:{allowedChildElements:{track:[],"#transparent":[],source:[]},allowedAttrs:{autoplay:[],buffered:[],controls:[],loop:[],mozcurrentsampleoffset:[],muted:[],played:[],preload:[],src:[],volume:[]}},source:{allowedAttrs:{src:[],type:[],media:[]}},track:{allowedAttrs:{"default":[],kind:[],label:[],src:[],srclang:[]}},canvas:{allowedAttrs:{width:[],height:[]}},map:{allowedChildElements:{"#transparent":[]}},area:{allowedAttrs:{alt:[],coords:[],download:[],href:[],hreflang:[],media:[],rel:[],shape:[],target:[],type:[]}},svg:{allowedAttrs:{version:[],baseprofile:[],contentscripttype:[],contentstyletype:[],x:[],y:[],width:[],height:[],viewbox:[],preserveaspectratio:[],zoomandpan:[],"xmlxml:space":[]}},math:{allowedAttrs:{dir:[],href:[],mathbackground:[],mathcolor:[],display:[],overflow:[],decimalpoint:[],displaystyle:[],infixlinebreakstyle:[],scriptlevel:[],scriptminsize:[],scriptsizemultiplier:[]}},table:{allowedChildElements:{caption:[],colgroup:[],thead:[],tfoot:[],tbody:[],tr:[]}},caption:[],colgroup:{allowedChildElements:{col:[]},allowedAttrs:{bgcolor:[],span:[]}},col:{allowedAttrs:{bgcolor:[],span:[]}},tbody:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},thead:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},tfoot:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},tr:{allowedChildElements:{td:[],th:[]}},td:{allowedAttrs:{bgcolor:[],colspan:[],headers:[],rowspan:[]}},th:{allowedAttrs:{bgcolor:[],colspan:[],headers:[],rowspan:[],scope:[]}},form:{allowedChildElements:{"#flow":[]},allowedAttrs:{"accept-charset":{action:[],autocomplete:[],enctype:[],method:[],name:[],novalidate:[],target:[]}}},fieldset:{allowedChildElements:{legend:[],"#flow":[]},allowedAttrs:{disabled:[],form:[],name:[]}},legend:{allowedChildElements:{"#phrasing":[]}},label:{allowedChildElements:{"#phrasing":[]},allowedAttrs:{accesskey:[],"for":[],form:[]}},input:{allowedAttrs:{type:[],accept:[],mozactionhint:[],autocomplete:[],autofocus:[],autosave:[],checked:[],disabled:[],form:[],formaction:[],formenctype:[],formmethod:[],formnovalidate:[],formtarget:[],height:[],inputmode:[],list:[],max:[],maxlength:[],min:[],multiple:[],name:[],pattern:[],placeholder:[],readonly:[],required:[],selectiondirection:[],size:[],spellcheck:[],src:[],step:[],value:[],width:[],"x-moz-errormessage":[]}},button:{allowedAttrs:{autofocus:[],disabled:[],form:[],formaction:[],formenctype:[],formmethod:[],formnovalidate:[],formtarget:[],name:[],type:[],value:[]}},select:{allowedChildElements:{option:[],optgroup:[]},allowedAttrs:{autofocus:[],disabled:[],form:[],multiple:[],name:[],required:[],size:[]}},datalist:{allowedChildElements:{"#phrasing":[],option:[]}},optgroup:{allowedChildElements:{option:[]},allowedAttrs:{disabled:[],label:[]}},option:{allowedAttrs:{disabled:[],label:[],selected:[],value:[]}},textarea:{allowedAttrs:{autofocus:[],cols:[],disabled:[],form:[],maxlength:[],name:[],placeholder:[],readonly:[],required:[],rows:[],selectiondirection:[],selectionend:[],selectionstart:[],spellcheck:[],wrap:[]}},keygen:{allowedAttrs:{autofocus:[],challenge:[],disabled:[],form:[],keytype:[],name:[]}},output:{allowedAttrs:{"for":[],form:[],name:[]}},progress:{allowedAttrs:{max:[],value:[]}},meter:{allowedAttrs:{value:[],min:[],max:[],low:[],high:[],optimum:[],form:[]}},details:{allowedChildElements:{summary:[],"#flow":[]},allowedAttrs:{open:[]}},summary:[],menuitem:{allowedAttrs:{checked:[],command:[],"default":[],disabled:[],icon:[],label:[],radiogroup:[],type:[]}},menu:{allowedChildElements:{"#flow":[],menuitem:[]},allowedAttrs:{type:[],label:[]}}}},contentCategories:{"#flow":{a:[],abbr:[],address:[],article:[],aside:[],audio:[],b:[],bdo:[],blockquote:[],br:[],button:[],canvas:[],cite:[],code:[],command:[],datalist:[],del:[],details:[],dfn:[],div:[],dl:[],em:[],embed:[],fieldset:[],figure:[],footer:[],form:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hgroup:[],hr:[],i:[],iframe:[],img:[],input:[],ins:[],kbd:[],keygen:[],label:[],main:[],map:[],mark:[],math:[],menu:[],meter:[],nav:[],noscript:[],object:[],ol:[],output:[],p:[],pre:[],progress:[],q:[],ruby:[],s:[],samp:[],script:[],section:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],table:[],textarea:[],time:[],u:[],ul:[],"var":[],video:[],wbr:[],"#text":[]},"#phrasing":{abbr:[],audio:[],b:[],bdi:[],bdo:[],br:[],button:[],canvas:[],cite:[],code:[],command:[],datalist:[],dfn:[],em:[],embed:[],i:[],iframe:[],img:[],input:[],kbd:[],keygen:[],label:[],mark:[],math:[],meter:[],noscript:[],object:[],output:[],progress:[],q:[],ruby:[],samp:[],script:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],textarea:[],time:[],"var":[],video:[],wbr:[],"#text":[]},"#palpable":{a:[],abbr:[],address:[],article:[],aside:[],audio:[],b:[],bdi:[],bdo:[],blockquote:[],button:[],canvas:[],cite:[],code:[],data:[],details:[],dfn:[],div:[],dl:[],em:[],embed:[],fieldset:[],figure:[],footer:[],form:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hgroup:[],i:[],iframe:[],img:[],input:[],ins:[],kbd:[],keygen:[],label:[],main:[],map:[],mark:[],math:[],menu:[],meter:[],nav:[],object:[],ol:[],output:[],p:[],pre:[],progress:[],q:[],ruby:[],s:[],samp:[],section:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],table:[],textarea:[],time:[],u:[],ul:[],"var":[],video:[],"#text":[]}}};function c(a,b,c){this.name=a,this.rules=b||{},this.callbacks=c||{},this.isLoaded=!1}b.ElementDirective=c,c.prototype={mayContain:function(a){return this.loadRules(),void 0!==this.rules.allowedChildElements[a]},mayContainAttribute:function(a){return"data-"===a.substr(0,5)?!0:(this.loadRules(),void 0!==this.rules.allowedAttrs[a])},isVoidElement:function(){return this.loadRules(),-1<b.elementRules.voidElements.indexOf(this.name)},loadRules:function(){var a,c,e,f;if(!this.isLoaded){switch(c={},e={},f={},this.name){case"html":c=b.elementRules.html.allowedAttrs,e=b.elementRules.html.allowedChildElements;break;case"head":c=b.elementRules.head.allowedAttrs,e=b.elementRules.head.allowedChildElements;break;case"body":c=b.elementRules.body.allowedAttrs,e=b.elementRules.body.allowedChildElements;break;default:b.elementRules.head.allowedChildElements[this.name]?a=b.elementRules.head.allowedChildElements[this.name]||{}:b.elementRules.body.allowedChildElements[this.name]&&(a=b.elementRules.body.allowedChildElements[this.name]||{}),c=a&&a.allowedAttrs?a.allowedAttrs:{},e=a&&a.allowedChildElements?a.allowedChildElements:{},a&&a.allowedChildElements&&(f=d(a.allowedChildElements))}this.extendAllowedAttrs(b.elementRules.globalAttrs),this.extendAllowedAttrs(c),this.extendAllowedChildElements(e),this.extendAllowedChildElements(f),this.isLoaded=!0}},extendAllowedAttrs:function(a){this.rules.allowedAttrs||(this.rules.allowedAttrs={});for(var b in a)this.rules.allowedAttrs[b]=a[b]},extendAllowedChildElements:function(a){this.rules.allowedChildElements||(this.rules.allowedChildElements={});for(var b in a)this.rules.allowedChildElements[b]=a[b]}};function d(a){var c,d,e={};for(c in a)if("#"===c.charAt(0))for(d in b.elementRules.contentCategories[c])e[d]=b.elementRules.contentCategories[c][d];return e}function e(a){this.name=a,this.isLoaded=!1,this.set=[]}b.ElementDirectiveSet=e,e.prototype={mayContain:function(a){var b,c;for(this.loadDirectives(),b=0,c=this.set.length;c>b;b++)if(this.set[b].mayContain(a))return!0;return!1},mayContainAttribute:function(a){var b,c;for(this.loadDirectives(),b=0,c=this.set.length;c>b;b++)if(this.set[b].mayContainAttribute(a))return!0;return!1},isVoidElement:function(){var a,b;for(this.loadDirectives(),a=0,b=this.set.length;b>a;a++)if(this.set[a].isVoidElement())return!0;return!1},loadDirectives:function(){this.isLoaded||(this.add(new b.ElementDirective(this.name)),this.isLoaded=!0)},add:function(a){this.set.push(a)}};function f(a,b){if(this.type=a,this.name=b,this.document=null,this.firstChild=null,this.lastChild=null,this.childNodes=[],this.attrs=[],this.index=0,this.parentNode=null,this.childCount=0,this.outerStartOffset=null,this.outerEndOffset=null,this.innerStartOffset=null,this.innerEndOffset=null,!this.name)throw new Error("Missing `name`");if(!this.type)throw new Error("Missing `type`")}b.Node=f,b.nodes={},f.NODE_ELEMENT=1,f.NODE_DOCUMENT=2,f.NODE_TEXT=3,f.NODE_ATTR=4,f.NODE_EXPR=5,f.NODE_COMMENT=6,f.prototype={setDocument:function(a){this.document=a},appendChild:function(a){return a.parentNode=this,f.NODE_TEXT?a.whiteSpace||(a.index=this.childCount,this.childCount++):(a.index=this.childCount,this.childCount++),this.childNodes.push(a),this.firstChild||(this.firstChild=a),this.lastChild=a,a},appendAttr:function(a){return a.parentNode=this,a.index=this.attrs.length,this.attrs.push(a),a},setOuterStartOffset:function(a){if(void 0===a)throw new Error("Argument to `setOuterStartOffset` cannot be undefined");this.outerStartOffset=Number(a)},setOuterEndOffset:function(a){if(void 0===a)throw new Error("Argument to `setOuterEndOffset` cannot be undefined");this.outerEndOffset=Number(a)},setInnerStartOffset:function(a){if(void 0===a)throw new Error("Argument to `setInnerStartOffset` cannot be undefined");this.innerStartOffset=Number(a)},setInnerEndOffset:function(a){if(void 0===a)throw new Error("Argument to `setInnerEndOffset` cannot be undefined");this.innerEndOffset=Number(a)},dump:function(){var a={},b,c;if(a.index=this.index,a.name=this.name,a.type=this.type,this.childNodes.length)for(a.childNodes=[],b=0,c=this.childNodes.length;c>b;b++)a.childNodes.push(this.childNodes[b].dump());return a}};function g(a){b.Node.call(this,b.Node.NODE_ELEMENT,a),this.directiveSet=null,this.id=null,this.previousSibling=null,this.nextSibling=null}g.prototype=Object.create(b.Node.prototype),g.prototype.constructor=g,b.nodes.Element=g,g.prototype.appendChild=function(a){return this.lastChild&&(a.previousSibling=this.lastChild,this.nextSibling=a),a.nextSibling=null,b.Node.prototype.appendChild.call(this,a),a},g.prototype.mayContain=function(a){return this.getDirectiveSet().mayContain(a)},g.prototype.mayContainAttribute=function(a){return this.getDirectiveSet().mayContainAttribute(a)},g.prototype.isVoidElement=function(){return this.getDirectiveSet().isVoidElement()},g.prototype.getDirectiveSet=function(){return null===this.directiveSet&&(this.directiveSet=new b.ElementDirectiveSet(this.name)),this.directiveSet},g.prototype.dump=function(){var a=b.Node.prototype.dump.call(this);return a.outerStartOffset=this.outerStartOffset,a.innerStartOffset=this.innerStartOffset,a.innerEndOffset=this.innerEndOffset,a.outerEndOffset=this.outerEndOffset,a.path=this.getUniquePath(),a},g.prototype.getUniquePath=function(){if("html"===this.name)return"html";var a,b=this;while(b.parentNode&&"html"!==b.parentNode.name){var c=b.name,d=b.parentNode,e=d.getChildrenByName(c);"body"!==c&&"head"!==c&&e.length>1&&(c+=":nth-child("+(b.index+1)+")"),a=c+(a?">"+a:""),b=d}return a},g.prototype.getChildrenByName=function(a){for(var b=[],c=0;c<this.childNodes.length;c++)a===this.childNodes[c].name&&b.push(this.childNodes[c]);return b};function h(a){b.Node.call(this,b.Node.NODE_ATTR,a)}h.prototype=Object.create(b.Node.prototype),h.prototype.constructor=h,b.nodes.Attr=h;function i(a){b.Node.call(this,b.Node.NODE_TEXT,"#text"),this.data=a||"",this.whiteSpace=!0}if(i.prototype=Object.create(b.Node.prototype),i.prototype.constructor=i,b.nodes.Text=i,i.prototype.appendData=function(a){this.data+=a},i.prototype.dump=function(){var a=b.Node.prototype.dump.call(this);return a.data=this.data,a},!b.Node)throw new Error("The structure.nodes.Comment class depends on the structure.Node class");b.nodes||(b.nodes={});function j(a){b.Node.call(this,b.Node.NODE_COMMENT,"#comment"),this.data=a||""}j.prototype=Object.create(b.Node.prototype),j.prototype.constructor=j,b.nodes.Comment=j,j.prototype.dump=function(){var a=b.Node.prototype.dump.call(this);return a.data=this.data,a};function k(a){this.input=a?a.replace(/(\r\n|\n|\r)/gm,"\n"):"",this.size=this.input.length,this.pointer=0,this.line=1,this.column=1}b.CharStream=k,k.prototype={getPointer:function(){return this.pointer},getSize:function(){return this.size},getLine:function(){return this.line},getColumn:function(){return this.column},consume:function(a){var b="",c,d=0;void 0===a&&(a=1);while(a>d)this.pointer<this.getSize()&&(c=this.input.charAt(this.pointer),"\n"===c&&(this.line++,this.column=0),b+=c,this.column++,this.pointer++),d++;return b.length?b:-1},next:function(a){var b="",c=0;void 0===a&&(a=1);while(a>c)this.pointer+c<this.getSize()&&(b+=this.input.charAt(this.pointer+c)),c++;return 0===b.length?-1:b},shift:function(a){var b=0,c;void 0===a&&(a=1);while(a>b)c=this.next(),"\n"===c&&(this.line++,this.column=0),this.column++,this.pointer++,b++}},b.CharTester={isWhiteSpace:function(a){return"\n"===a||"	"===a||" "===a},isUpperCase:function(a){return a>="A"&&"Z">=a},isLowerCase:function(a){return a>="a"&&"z">=a},isNumber:function(a){return a>="0"&&"9">=a},isAlpha:function(a){return this.isUpperCase(a)||this.isLowerCase(a)}};function l(a){b.Node.call(this,b.Node.NODE_DOCUMENT,"#document"),this.debug=!1,this.input=a||"",this.parser=null,this.compiler=null,this.reset()}l.prototype=Object.create(b.Node.prototype),l.prototype.constructor=l,b.Document=l,l.prototype.setInput=function(a){a!==this.input&&(this.input=a,this.reset())},l.prototype.reset=function(){this.parser&&this.parser.reset(),this.childNodes=[],this.attrs=[],this.firstChild=null,this.lastChild=null,this.outerStartOffset=null,this.outerEndOffset=null,this.innerStartOffset=null,this.innerEndOffset=null,this.documentElement=null,this.titleElement=null,this.body=null,this.isParsed=!1,this.isCompiled=!1,this.output=null},l.prototype.createElement=function(a){var c=new b.nodes.Element(a);switch(c.setDocument(this),a){case"html":if(this.documentElement)throw new Error("The <html> element already exists");this.documentElement=c;break;case"body":if(this.body)throw new Error("The <body> element already exists");this.body=c;break;case"title":if(this.titleElement)throw new Error("The <title> element already exists");this.titleElement=c}return c},l.prototype.createText=function(a){var c=new b.nodes.Text(a);return c.setDocument(this),c},l.prototype.createComment=function(a){var c=new b.nodes.Comment(a);return c.setDocument(this),c},l.prototype.createAttr=function(a){var c=new b.nodes.Attr(a);return c.setDocument(this),c},l.prototype.getParser=function(){return null===this.parser&&(this.parser=new b.Parser(this)),this.parser},l.prototype.getCompiler=function(){return null===this.compiler&&(this.compiler=new b.Compiler(this)),this.compiler},l.prototype.parse=function(){this.isParsed||(this.getParser().parse(this.input),this.isParsed=!0)},l.prototype.compile=function(a){return a&&this.setInput(a),this.isCompiled||(this.parse(),this.output=this.getCompiler().compile(),this.isCompiled=!0),this.output},b.Token={EOF:"EOF",CHAR:"CHAR",DOCTYPE:"DOCTYPE",COMMENT:"COMMENT",START_TAG:"START_TAG",START_TAG_CLOSE:"START_TAG_CLOSE",START_TAG_NAME:"START_TAG_NAME",END_TAG:"END_TAG",ATTR_KEY:"ATTR_KEY",START_ATTR_VALUE:"START_ATTR_VALUE",END_ATTR_VALUE:"END_ATTR_VALUE",EXPR_OPEN:"EXPR_OPEN",VARIABLE:"VARIABLE",FUNC:"FUNC",END_FUNC:"END_FUNC",DOT:"DOT",STR:"STR",NUM:"NUM",EXPR_CLOSE:"EXPR_CLOSE",OPERATOR:"OPERATOR",META:"META",END_META:"END_META",START_ARR:"START_ARR",END_ARR:"END_ARR",START_OBJ:"START_OBJ",END_OBJ:"END_OBJ"};function m(a){if(!a)throw new Error("Missing `parser` for Tokenizer");this.parser=a,this.reset(),this.openExprDelim="[[",this.closeExprDelim="[[",this.replacementChar="?"}b.Tokenizer=m,m.STATE_EOF="STATE_EOF",m.STATE_DATA="STATE_DATA",m.STATE_MARKUP_DECLARATION_OPEN="STATE_MARKUP_DECLARATION_OPEN",m.STATE_COMMENT_START="STATE_COMMENT_START",m.STATE_COMMENT_START_DASH="STATE_COMMENT_START_DASH",m.STATE_COMMENT="STATE_COMMENT",m.STATE_COMMENT_END_DASH="STATE_COMMENT_END_DASH",m.STATE_COMMENT_END="STATE_COMMENT_END",m.STATE_BOGUS_COMMENT="STATE_BOGUS_COMMENT",m.STATE_CHAR_REF_IN_DATA="STATE_CHAR_REF_IN_DATA",m.STATE_TAG_OPEN="STATE_TAG_OPEN",m.STATE_TAG_NAME="STATE_TAG_NAME",m.STATE_SELF_CLOSING_START_TAG="STATE_SELF_CLOSING_START_TAG",m.STATE_BEFORE_ATTR_KEY="STATE_BEFORE_ATTR_KEY",m.STATE_END_TAG_OPEN="STATE_END_TAG_OPEN",m.STATE_END_TAG_NAME="STATE_END_TAG_NAME",m.STATE_RAWTEXT="STATE_RAWTEXT",m.STATE_RAWTEXT_LESS_THAN_SIGN="STATE_RAWTEXT_LESS_THAN_SIGN",m.STATE_RAWTEXT_END_TAG_OPEN="STATE_RAWTEXT_END_TAG_OPEN",m.STATE_RAWTEXT_END_TAG_NAME="STATE_RAWTEXT_END_TAG_NAME",m.STATE_BEFORE_ATTR_KEY="STATE_BEFORE_ATTR_KEY",m.STATE_ATTR_KEY="STATE_ATTR_KEY",m.STATE_BEFORE_ATTR_VALUE="STATE_BEFORE_ATTR_VALUE",m.STATE_ATTR_VALUE="STATE_ATTR_VALUE",m.STATE_AFTER_ATTR_VALUE="STATE_AFTER_ATTR_VALUE";var n={},o=b.Token,p=b.CharTester;m.prototype={reset:function(){this.state=m.STATE_DATA,this.tok=null,this.buffer="",this.prevStartTagToken=null,this.attrDelimiter=null},tokenize:function(a){var c=new b.CharStream(a),d=0;while(!0){if(this.parser.document.debug&&this.parser.debug(this.state+".tokenize("+c.next()+")"),void 0===n[this.state])throw new Error("Unexpected tokenizer state: "+this.state);if(n[this.state](this,c),d++,d>3e3)throw new Error("Tokenizer running wild?");if(m.STATE_EOF===this.state)return}if(m.STATE_EOF!==this.state)throw new Error("The tokenizer did not finish (state was "+this.state+", but should be STATE_EOF)")},emit:function(a){if(a||(a=this.tok,this.tok=null),this.tok)throw new Error("The tokenizer has an unemitted token");o.START_TAG===a.type&&(this.prevStartTagToken=a),this.parser.handleToken(a)},currentEndTagIsAppropriate:function(){if(o.END_TAG!==this.tok.type)throw new Error("The current token is not an end tag: "+this.tok.type);return this.prevStartTagToken&&this.tok.name===this.prevStartTagToken.name},setState:function(a){if(void 0===a)throw new Error("Cannot set undefined state");this.state=a}},n[m.STATE_DATA]=function(a,b){var c=b.consume();switch(!0){case"&"===c:a.setState(m.STATE_CHAR_REF_IN_DATA);break;case"<"===c:a.setState(m.STATE_TAG_OPEN);break;case-1===c:a.setState(m.STATE_EOF),a.emit({type:o.EOF});break;case a.openExprDelim===c+b.next(a.openExprDelim.length-1):a.parser.report("exception","Not implemented (STATE_DATA)");break;case"\x00"===c:a.parser.report("exception","Unexpected NULL character (STATE_DATA)"),a.emit({type:o.CHAR,data:a.replacementChar});break;default:a.emit({type:o.CHAR,data:c})}},n[m.STATE_MARKUP_DECLARATION_OPEN]=function(a,b){switch(!0){case"--"===b.next(2):b.shift(2),a.tok={type:o.COMMENT,data:""},a.setState(m.STATE_COMMENT_START);break;case"DOCTYPE"===String(b.next(7)).toUpperCase():b.shift(7),a.setState(m.STATE_DOCTYPE);break;default:var c=b.next();a.parser.report("error","Unexpected character: "+c+" (STATE_MARKUP_DECLARATION_OPEN)"),a.setState(m.STATE_BOGUS_COMMENT),-1!==c&&(a.buffer=c)}},n[m.STATE_COMMENT_START]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(m.STATE_COMMENT_START_DASH);break;case"\x00"===c:b.consume(),a.parser.report("error","Unexpected NULL character (STATE_COMMENT_START)"),a.tok.data+=a.replacementChar;break;case">"===c:b.consume(),a.parser.report("error","Unexpected > character (STATE_COMMENT_START)"),a.setState(m.STATE_DATA),a.emit();break;case-1===c:a.parser.report("error","Unexpected EOF (STATE_COMMENT_START)"),a.setState(m.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+=c,a.setState(m.STATE_COMMENT)}},n[m.STATE_COMMENT_START_DASH]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(m.STATE_COMMENT_END);break;case"\x00"===c:b.consume(),a.parser.report("error","Unexpected NULL character in STATE_COMMENT_START_DASH"),a.tok.data+="-"+a.replacementChar,a.setState(m.STATE_COMMENT);break;case">"===c:b.consume(),a.parser.report("error","Unexpected > character in STATE_COMMENT_START_DASH"),a.setState(m.STATE_DATA),a.emit();break;case-1===c:a.parser.report("error","Unexpected EOF character in STATE_COMMENT_START_DASH"),a.setState(m.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+="-"+c,a.setState(m.STATE_COMMENT)}},n[m.STATE_COMMENT]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(m.STATE_COMMENT_END_DASH);break;case"\x00"===c:b.consume(),a.parser.report("error","Encountered NULL character (STATE_COMMENT)"),a.tok.data+=a.replacementChar;break;case-1===c:a.parser.report("error","Encountered EOF (STATE_COMMENT)"),a.setState(m.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+=c}},n[m.STATE_COMMENT_END_DASH]=function(a,b){var c=b.consume();switch(!0){case"-"===c:a.setState(m.STATE_COMMENT_END);break;default:a.tok.data+=c,a.setState(m.STATE_COMMENT)}},n[m.STATE_COMMENT_END]=function(a,b){var c=b.consume();switch(!0){case">"===c:a.setState(m.STATE_DATA),a.emit();break;case"\x00"===c:a.parser.report("error","Unexpected NULL character (STATE_COMMENT_END)"),a.tok.data+="--"+a.replacementChar,a.setState(m.STATE_COMMENT);break;case"!"===c:a.parser.report("error","Unexpected `!` (STATE_COMMENT_END)"),a.setState(m.STATE_COMMENT_END_BANG);break;case"-"===c:a.parser.report("error","Unexpected `-` (STATE_COMMENT_END)"),a.tok.data+="-";break;case-1===c:a.parser.report("error","Unexpected EOF (STATE_COMMENT_END)"),a.setState(m.STATE_DATA),a.emit();break;default:a.parser.report("error","Unexpected character: "+c+" (STATE_COMMENT_END)"),a.tok.data+="--"+c,a.setState(m.STATE_COMMENT)}},n[m.STATE_BOGUS_COMMENT]=function(a,b){var c="",d="";while(">"!==c&&-1!==c)c=b.consume(),-1!==c&&(d+="\x00"===c?a.replacementChar:c);b.consume(),a.emit({type:o.COMMENT,data:d}),a.state=m.STATE_DATA},n[m.STATE_TAG_OPEN]=function(a,b){var c=b.consume();switch(!0){case"!"===c:a.setState(m.STATE_MARKUP_DECLARATION_OPEN);break;case"/"===c:a.setState(m.STATE_END_TAG_OPEN);break;case">"===c:a.emit({type:o.CHAR,data:"<>"}),a.setState(m.STATE_DATA);break;case"<"===c:a.emit({type:o.CHAR,data:"<"});break;case p.isWhiteSpace(c):a.emit({type:o.CHAR,data:"<".chr}),a.setState(m.STATE_DATA);break;case p.isUpperCase(c):a.tok={type:o.START_TAG,name:c.toLowerCase(),offset:b.pointer-2},a.setState(m.STATE_TAG_NAME);break;case p.isLowerCase(c):a.tok={type:o.START_TAG,name:c,offset:b.pointer-2},a.setState(m.STATE_TAG_NAME);break;case"?"===c:a.parser.report("exception","Unexpected character in tag open: ? (STATE_TAG_OPEN)"),a.setState(m.STATE_BOGUS_COMMENT),a.buffer=c;break;case-1===c:a.parser.report("notice","Unexpected EOF in tag open (STATE_TAG_OPEN)"),a.setState(m.STATE_DATA),a.emit({type:o.CHAR,data:"&lt;"});break;default:a.parser.report("notice","Unexpected character in tag open: "+c+" (STATE_TAG_OPEN)"),a.setState(m.STATE_DATA),a.emit({type:o.CHAR,data:"&lt;".chr})}},n[m.STATE_TAG_NAME]=function(a,b){var c=b.consume(),d;switch(!0){case p.isUpperCase(c):c=c.toLowerCase(),a.tok.name+=c;break;case p.isLowerCase(c):case p.isNumber(c):a.tok.name+=c;break;case p.isWhiteSpace(c):a.emit(),a.setState(m.STATE_BEFORE_ATTR_KEY);break;case">"===c:a.emit(),a.setState(m.STATE_DATA),a.emit({type:o.START_TAG_CLOSE,selfClosing:!1,offset:b.pointer});break;case"/"===c:a.emit(),a.setState(m.STATE_SELF_CLOSING_START_TAG);break;case-1===c:a.parser.report("notice","Unexpected EOF in tag name"),d=a.tok.name,a.tok=null,a.emit({type:o.CHAR,data:"&lt;"+d}),a.setState(m.STATE_DATA);break;default:a.parser.report("notice","Unexpected character in tag name: "+c),d=a.tok.name,a.tok=null,a.emit({type:o.CHAR,data:"&lt;"+d+c}),a.setState(m.STATE_DATA)}},n[m.STATE_END_TAG_OPEN]=function(a,b){var c=b.consume();switch(!0){case p.isUpperCase(c):a.tok={type:o.END_TAG,name:c.toLowerCase(),innerOffset:b.pointer-3},a.setState(m.STATE_END_TAG_NAME);break;case p.isLowerCase(c):a.tok={type:o.END_TAG,name:c,innerOffset:b.pointer-3},a.setState(m.STATE_END_TAG_NAME);break;case-1===c:a.emit({type:o.CHAR,data:"&lt;/"}),a.setState(m.STATE_DATA);break;default:a.parser.report("exception","Unexpected character in end tag open: "+c)}},n[m.STATE_END_TAG_NAME]=function(a,b){var c=b.consume(),d;switch(!0){case p.isUpperCase(c):a.tok.name+=c.toUpperCase();break;case p.isLowerCase(c):case p.isNumber(c):a.tok.name+=c;break;case">"===c:a.tok.outerOffset=b.pointer,a.emit(),a.setState(m.STATE_DATA);break;case-1===c:d=a.tok.name,a.tok=null,a.emit({type:o.CHAR,data:"&lt;/"+d}),a.setState(m.STATE_DATA);break;default:a.parser.report("exception","Unexpected character in end tag name: "+c)}},n[m.STATE_RAWTEXT]=function(a,b){var c=b.consume();switch(!0){case"<"===c:a.setState(m.STATE_RAWTEXT_LESS_THAN_SIGN);break;case"\x00"===c:a.parser.report("error","Unexpected NULL characted in rawtext (STATE_RAWTEXT)"),a.emit({type:o.CHAR,data:a.replacementChar});break;case-1===c:a.emit({type:o.EOF}),a.setState(m.STATE_DATA);break;default:a.emit({type:o.CHAR,data:c})}},n[m.STATE_RAWTEXT_LESS_THAN_SIGN]=function(a,b){var c=b.next();switch(!0){case"/"===c:b.consume(),a.buffer="",a.setState(m.STATE_RAWTEXT_END_TAG_OPEN);break;default:a.setState(m.STATE_RAWTEXT),a.emit({type:o.CHAR,data:"<"})}},n[m.STATE_RAWTEXT_END_TAG_OPEN]=function(a,b){var c=b.next();switch(!0){case p.isUpperCase(c):b.consume(),a.tok={type:o.END_TAG,name:c.toLowerCase()},a.buffer+=c,a.setState(m.STATE_RAWTEXT_END_TAG_NAME);break;case p.isLowerCase(c):b.consume(),a.tok={type:o.END_TAG,name:c},a.buffer+=c,a.setState(m.STATE_RAWTEXT_END_TAG_NAME);break;default:a.setState(m.STATE_RAWTEXT),a.emit({type:o.CHAR,data:"</"})}},n[m.STATE_RAWTEXT_END_TAG_NAME]=function(a,b){var c=b.next();switch(!0){case p.isWhiteSpace(c):a.currentEndTagIsAppropriate()?(b.consume(),a.setState(m.STATE_BEFORE_ATTR_KEY)):(a.setState(m.STATE_RAWTEXT),a.tok=null,a.emit({type:o.CHAR,data:"</"+a.buffer}));break;case"/"===c:a.currentEndTagIsAppropriate()?(b.consume(),a.setState(m.STATE_SELF_CLOSING_START_TAG)):(a.setState(m.STATE_RAWTEXT),a.tok=null,a.emit({type:o.CHAR,data:"</"+a.buffer}));break;case">"===c:a.currentEndTagIsAppropriate()?(b.consume(),a.setState(m.STATE_DATA),a.emit()):(a.setState(m.STATE_RAWTEXT),a.tok=null,a.emit({type:o.CHAR,data:"</"+a.buffer}));break;case p.isUpperCase(c):b.consume(),a.tok.name+=c.toLowerCase(),a.buffer+=c;break;case p.isLowerCase(c):b.consume(),a.tok.name+=c,a.buffer+=c;break;default:a.setState(m.STATE_RAWTEXT),a.tok=null,a.emit({type:o.CHAR,data:"</"+a.buffer})}},n[m.STATE_BEFORE_ATTR_KEY]=function(a,b){var c=b.consume();switch(!0){case p.isWhiteSpace(c):break;case p.isUpperCase(c):a.tok={type:o.ATTR_KEY,name:c.toLowerCase()},a.setState(m.STATE_ATTR_KEY);break;case p.isLowerCase(c):a.tok={type:o.ATTR_KEY,name:c},a.setState(m.STATE_ATTR_KEY);break;case-1===c:a.parser.report("error","Unexpected end of file before attribute key: "+c+" (STATE_BEFORE_ATTR_KEY)"),a.setState(m.STATE_DATA),a.emit({type:o.START_TAG_CLOSE,offset:-1});break;default:a.parser.report("exception","Unexpected character before attribute key: "+c+" (STATE_BEFORE_ATTR_KEY)")}},n[m.STATE_ATTR_KEY]=function(a,b){var c=b.consume();switch(!0){case"="===c:a.emit(),a.setState(m.STATE_BEFORE_ATTR_VALUE);break;case p.isUpperCase(c):case p.isLowerCase(c):case"-"===c:a.tok.name+=c.toLowerCase();break;case-1===c:a.parser.report("exception","Unexpected end of file before attribute key: "+c+" (STATE_ATTR_KEY)");break;default:a.parser.report("exception","Unexpected character in attribute key: "+c+" (STATE_ATTR_KEY)")}},n[m.STATE_BEFORE_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case p.isWhiteSpace(c):break;case"["===c:a.emit({type:o.START_ARR}),a.setState(m.STATE_AFTER_ATTR_VALUE),a.pushState(m.BEFORE_JSON_ARRAY_VALUE);break;case"{"===c:a.emit({type:o.START_OBJ}),a.setState(m.STATE_AFTER_ATTR_VALUE),a.pushState(m.BEFORE_JSON_OBJECT_KEY);break;case'"'===c:case"'"===c:a.attrDelimiter=c,a.emit({type:o.START_ATTR_VALUE}),a.setState(m.STATE_ATTR_VALUE);break;default:a.parser.report("exception","Unexpected character before attribute value: "+c)}},n[m.STATE_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case a.attrDelimiter===c:a.emit({type:o.END_ATTR_VALUE}),a.setState(m.STATE_AFTER_ATTR_VALUE);break;case-1===c:a.emit({type:o.END_ATTR_VALUE}),a.setState(m.STATE_AFTER_ATTR_VALUE),a.parser.report("error","Unexpected EOF in attribute value");break;default:a.emit({type:o.CHAR,data:c})}},n[m.STATE_AFTER_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case p.isWhiteSpace(c):a.setState(m.STATE_BEFORE_ATTR_KEY);break;case">"===c:a.setState(m.STATE_DATA),a.emit({type:o.START_TAG_CLOSE,selfClosing:!1,offset:b.getPointer()});break;case-1===c:a.setState(m.STATE_DATA),a.emit({type:o.START_TAG_CLOSE,selfClosing:!1,offset:b.getPointer()});break;default:a.parser.report("exception","Unexpected character after attribute value: "+c)}};function q(a){if(!a)throw new Error("Missing `parser` for TreeConstructor");this.parser=a,this.reset()}var r={},o=b.Token,p=b.CharTester;b.TreeConstructor=q,q.MODE_INITIAL="MODE_INITIAL",q.MODE_BEFORE_HTML="MODE_BEFORE_HTML",q.MODE_BEFORE_HEAD="MODE_BEFORE_HEAD",q.MODE_IN_HEAD="MODE_IN_HEAD",q.MODE_AFTER_HEAD="MODE_AFTER_HEAD",q.MODE_IN_BODY="MODE_IN_BODY",q.MODE_AFTER_BODY="MODE_AFTER_BODY",q.MODE_AFTER_HTML="MODE_AFTER_HTML",q.MODE_IN_START_TAG="MODE_IN_START_TAG",q.MODE_IN_TEXT="MODE_IN_TEXT",q.MODE_ATTR_VALUE="MODE_ATTR_VALUE",q.prototype={reset:function(){this.mode=q.MODE_INITIAL,this.nodeStack=[],this.modeStack=[],this.pushNode(this.parser.document)
},handleToken:function(a){if(void 0===this.mode)throw new Error("The tree constructor's mode cannot be undefined");if(!a)throw new Error("Token must be provided");if("object"!=typeof a)throw new Error("Token must be an object");if(void 0===a.type)throw new Error("Token type cannot be undefined");if(this.parser.document.debug&&this.parser.debug(this.mode+".handleToken("+a.type+")"),void 0===r[this.mode])throw new Error("Unknown tree constructor mode: "+this.mode);r[this.mode](this,a)},setMode:function(a){if(void 0===a)throw new Error("Cannot set undefined mode");this.mode=a},pushMode:function(a){if(void 0===a)throw new Error("cannot push undefined mode");this.modeStack.push(this.mode),this.mode=a},popMode:function(){if(!this.modeStack.length)throw new Error("The mode stack is already empty");if(this.mode=this.modeStack.pop(),void 0===this.mode)throw new Error("cannot pop undefined mode")},pushNode:function(a){this.nodeStack.push(a),this.node=a},popNode:function(){if(!this.nodeStack.length)throw new Error("The node stack is already empty");var a=this.nodeStack.pop();return this.node=this.nodeStack[this.nodeStack.length-1],a},insertElement:function(a){var b=this.parser.document.createElement(a);return this.node.appendChild(b),this.pushNode(b),b},insertChar:function(a){var c=this.parser.document.createText(a);return this.node.lastChild&&b.Node.NODE_TEXT===this.node.lastChild.type?this.node.lastChild.appendData(a):this.node.appendChild(c),p.isWhiteSpace(a)||(this.node.lastChild.whiteSpace=!1),c},insertComment:function(a){var b=this.parser.document.createComment(a);return this.node.appendChild(b),b},insertAttr:function(a){var b=this.parser.document.createAttr(a);return this.node.appendAttr(b),this.pushNode(b),b},assertTitleElementExists:function(){this.parser.document.titleElement||(this.insertElement("title"),this.popNode())}},r[q.MODE_INITIAL]=function(a,b){switch(!0){case o.COMMENT===b.type||o.CHAR&&p.isWhiteSpace(b.data):break;case o.DOCTYPE===b.type:a.parser.report("debug","Insert <!DOCTYPE "+b.name+"> (MODE_INITIAL)"),a.insertDoctype(b.name),a.setMode(q.MODE_BEFORE_HTML);break;default:a.parser.report("debug","Force insert <!DOCTYPE html> (MODE_INITIAL)"),a.setMode(q.MODE_BEFORE_HTML),a.handleToken(b)}},r[q.MODE_BEFORE_HTML]=function(a,b){switch(!0){case o.CHAR===b.type&&p.isWhiteSpace(b.data):a.insertChar(b.data);break;case o.START_TAG===b.type:"html"===b.name?(a.parser.report("debug","Inserting <html> (MODE_BEFORE_HTML)"),a.insertElement("html"),a.pushMode(q.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <html> before attempting to insert <"+b.name+"> (MODE_BEFORE_HTML)"),a.insertElement("html"),a.setMode(q.MODE_BEFORE_HEAD),a.handleToken(b));break;case o.START_TAG_CLOSE===b.type:a.setMode(q.MODE_BEFORE_HEAD),a.node.setInnerStartOffset(b.offset);break;case o.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <html> before proceeding to handle token: "+b.type+" (MODE_BEFORE_HTML)"),a.insertElement("html"),a.setMode(q.MODE_BEFORE_HEAD),a.handleToken(b)}},r[q.MODE_BEFORE_HEAD]=function(a,b){switch(!0){case o.CHAR===b.type&&p.isWhiteSpace(b.data):a.insertChar(b.data);break;case o.START_TAG===b.type:"head"===b.name?(a.parser.report("debug","Inserting <head> (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.node.setOuterStartOffset(b.offset),a.setMode(q.MODE_IN_HEAD),a.pushMode(q.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <head> before attempting to insert <"+b.name+"> (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.setMode(q.MODE_IN_HEAD),a.handleToken(b));break;case o.START_TAG_CLOSE===b.type:a.node.setInnerStartOffset(b.offset),a.setMode(q.MODE_IN_HEAD);break;case o.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <head> before proceeding to handle token: "+b.type+" (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.setMode(q.MODE_IN_HEAD),a.handleToken(b)}},r[q.MODE_IN_HEAD]=function(a,c){switch(!0){case o.CHAR===c.type&&p.isWhiteSpace(c.data):a.insertChar(c.data);break;case o.END_TAG===c.type:"head"===c.name?(a.parser.report("debug","Inserting </head> (MODE_IN_HEAD)"),a.setMode(q.MODE_AFTER_HEAD),a.node.setInnerEndOffset(c.innerOffset),a.node.setOuterEndOffset(c.outerOffset),a.popNode()):a.parser.report("exception","Unexpected end tag: </"+c.name+">");break;case o.START_TAG===c.type:if(a.node.mayContain(c.name))a.insertElement(c.name),a.node.setOuterStartOffset(c.offset),a.pushMode(q.MODE_IN_START_TAG);else{a.parser.report("debug","Inserting </head> before attempting to insert <"+c.name+"> (MODE_IN_HEAD)");while("head"!==a.node.name)a.popNode();a.popNode(),a.setMode(q.MODE_AFTER_HEAD),a.handleToken(c)}break;case o.START_TAG_CLOSE===c.type:a.parser.report("debug","End start tag: <"+a.node.name+"> (MODE_IN_HEAD)"),a.node.setInnerStartOffset(c.offset),-1<["title","script","style"].indexOf(a.node.name)?(a.pushMode(q.MODE_IN_TEXT),a.parser.tokenizer.setState(b.Tokenizer.STATE_RAWTEXT)):a.node.isVoidElement()&&a.popNode();break;case o.COMMENT===c.type:a.insertComment(c.data);break;default:a.parser.report("debug","Inserting </head> before continuing to process token: "+c.type+" (MODE_IN_HEAD)");while("head"!==a.node.name)a.popNode();a.assertTitleElementExists(),a.popNode(),a.setMode(q.MODE_AFTER_HEAD),a.handleToken(c)}},r[q.MODE_AFTER_HEAD]=function(a,b){switch(!0){case o.CHAR===b.type&&p.isWhiteSpace(b.data):a.insertChar(b.data);break;case o.START_TAG===b.type:"body"===b.name?(a.parser.report("debug","Inserting <body> (MODE_AFTER_HEAD)"),a.insertElement("body"),a.node.setOuterStartOffset(b.offset),a.setMode(q.MODE_IN_BODY),a.pushMode(q.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <body> before attempting to insert <"+b.name+"> (MODE_AFTER_HEAD)"),a.insertElement("body"),a.setMode(q.MODE_IN_BODY),a.handleToken(b));break;case o.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <body> before proceeding to handle token: "+b.type+" (MODE_AFTER_HEAD)"),a.insertElement("body"),a.setMode(q.MODE_IN_BODY),a.handleToken(b)}},r[q.MODE_IN_BODY]=function(a,b){switch(!0){case o.CHAR===b.type:a.insertChar(b.data);break;case o.START_TAG===b.type:a.node.mayContain(b.name)?(a.parser.report("debug","Inserting <"+b.name+"> (MODE_IN_BODY)"),a.insertElement(b.name),a.node.setOuterStartOffset(b.offset),a.pushMode(q.MODE_IN_START_TAG)):a.parser.report("exception","Unexpected start tag in "+a.node.name+": "+b.name+" (MODE_IN_BODY)");break;case o.START_TAG_CLOSE===b.type:(a.node.isVoidElement()||b.selfClosing)&&(a.parser.report("debug","Self-closing <"+a.node.name+">"),a.popNode()),a.node.setInnerStartOffset(b.offset);break;case o.END_TAG===b.type:switch(b.name){case"body":case"html":while("body"!==a.node.name)a.parser.report("debug","Inserting </"+a.node.name+"> (MODE_IN_BODY)"),a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode();a.parser.report("debug","Inserting </body> (MODE_IN_BODY)"),a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode(),a.setMode(q.MODE_AFTER_BODY),"html"===b.name&&a.handleToken(b);break;default:b.name===a.node.name?(a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode()):a.parser.report("exception","Unexpected end tag </"+b.name+"> in <"+a.node.name+"> (MODE_IN_BODY)")}break;case o.EOF===b.type:a.parser.report("debug","Inserting </body> at end of file (MODE_IN_BODY)");while("body"!==a.node.name)a.popNode();a.setMode(q.MODE_AFTER_BODY),a.handleToken(b);break;case o.COMMENT===b.type:a.insertComment(b.data);break;case o.EXPR_OPEN===b.type:a.insertExpr(),a.pushMode(q.MODE_IN_EXPR);break;default:a.parser.report("exception","Unexpected token in body: "+b.type)}},r[q.MODE_AFTER_BODY]=function(a,b){switch(!0){case o.CHAR===b.type&&p.isWhiteSpace(b.data):a.insertChar(b.data);break;case o.EOF===b.type:a.parser.report("debug","Inserting </html> at end of file (MODE_AFTER_BODY)");while("html"!==a.node.name)a.popNode();a.setMode(q.MODE_AFTER_HTML),a.handleToken(b);break;case o.END_TAG===b.type:if("html"===b.name){while("html"!==a.node.name)a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode();a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode(),a.setMode(q.MODE_AFTER_HTML)}else a.parser.report("exception","Unexpected end tag </"+b.name+"> (MODE_AFTER_BODY)");break;case o.COMMENT===b.type:a.insertComment(b.data);break;case o.START_TAG===b.type:a.parser.report("error","Unexpected start tag <"+b.name+"> after body (MODE_AFTER_BODY)"),a.setMode(q.MODE_IN_BODY),a.pushNode(a.parser.document.bodyElement),a.handleToken(b);break;default:a.parser.report("exception","Unexpected token after body: "+b.type),a.setMode(q.MODE_IN_BODY),a.pushNode(a.parser.document.bodyElement),a.handleToken(b)}},r[q.MODE_IN_START_TAG]=function(a,c){switch(!0){case o.START_TAG_CLOSE===c.type:a.popMode(),b.Node.NODE_ATTR===a.node.type&&a.popNode(),a.handleToken(c);break;case o.START_ARR===c.type:a.insertArray(),a.pushMode(q.MODE_ARR);break;case o.START_OBJ===c.type:a.insertObject(),a.pushMode(q.MODE_OBJ);break;case o.ATTR_KEY===c.type:while(b.Node.NODE_ATTR===a.node.type)a.popNode();a.insertAttr(a.node.mayContainAttribute(c.name)?c.name:"data-"+c.name);break;case o.START_ATTR_VALUE===c.type:a.pushMode(q.MODE_ATTR_VALUE);break;default:a.parser.report("exception","Unexpected token in start tag mode: ".tok.type)}},r[q.MODE_AFTER_HTML]=function(a,b){switch(!0){case o.CHAR===b.type&&p.isWhiteSpace(b.data):a.insertChar(b.data);break;case o.COMMENT===b.type:a.insertComment(b.data);break;case o.EOF===b.type:break;default:a.parser.report("exception","Unexpected token after html: "+b.type)}},r[q.MODE_IN_TEXT]=function(a,b){switch(!0){case o.CHAR===b.type:a.insertChar(b.data);break;case o.EOF===b.type:a.parser.report("error","Unexpected end of file in text mode (MODE_IN_TEXT)"),"script"===a.node&&(a.node.alreadyStarted=!0),a.popNode(),a.popMode(),a.handleToken(b);break;case o.END_TAG===b.type:if("script"===b.name)throw new Error("NOT IMPLEMENTED");a.popNode(),a.popMode()}},r[q.MODE_ATTR_VALUE]=function(a,b){switch(!0){case o.CHAR===b.type:a.insertChar(b.data);break;case o.END_ATTR_VALUE===b.type:a.popMode(),a.popNode();break;case o.EOF===b.type:a.parser.report("error","Unexpected token in attribute value: "+b.type+" (MODE_ATTR_VALUE)");break;default:a.parser.report("exception","Unexpected token in attribute value: "+b.type+" (MODE_ATTR_VALUE)")}};function s(a){if(!a)throw new Error("Missing `document` for Parser");this.document=a,this.treeConstructor=null,this.tokenizer=null,this.messages=[]}b.Parser=s,s.prototype={reset:function(){this.treeConstructor&&this.treeConstructor.reset(),this.tokenizer&&this.tokenizer.reset(),this.messages=[]},parse:function(a){this.getTokenizer().tokenize(a)},handleToken:function(a){this.getTreeConstructor().handleToken(a)},getTokenizer:function(){return null===this.tokenizer&&(this.tokenizer=new b.Tokenizer(this)),this.tokenizer},getTreeConstructor:function(){return null===this.treeConstructor&&(this.treeConstructor=new b.TreeConstructor(this)),this.treeConstructor},report:function(a,b){if("exception"===a)throw new Error(b);"notice"===a?console.warn(">> Parser.NOTICE",b):"error"===a&&console.error(">> Parser.ERROR",b),this.messages.push({type:a,message:b})},debug:function(){var a,b,c;for(a=0,b=arguments.length;b>a;a++){if(c=arguments[a],"object"==typeof c)throw new Error("Can't debug objects (yet)");this.report("debug",c)}}};function t(a){if(!a)throw new Error("Missing `document` for Compiler");this.document=a}b.Compiler=t,t.prototype={compile:function(){return this.compileNodes(this.document.childNodes)},compileNodes:function(a){var b,c,d="";for(b=0,c=a.length;c>b;b++)d+=this.compileNode(a[b]);return d},compileNode:function(a){var c="";switch(a.type){case b.Node.NODE_ELEMENT:c+="<",c+=a.name,c+=this.compileNodes(a.attrs),c+=">",a.isVoidElement()||(c+=this.compileNodes(a.childNodes),c+="</",c+=a.name,c+=">");break;case b.Node.NODE_TEXT:c+=a.data;break;case b.Node.NODE_COMMENT:c+="<!--",c+=a.data,c+="-->";break;case b.Node.NODE_ATTR:c+=" ",c+=a.name,c+='="',c+=this.compileNodes(a.childNodes),c+='"';break;default:throw new Error("Unsupported node type in compiler: "+a.type)}return c}}}(this);
//# sourceMappingURL=structure.min.js.map