/*! Transclusion.js v0.0.1 | (c) 2015 Marius Lundg√•rd | http://mariuslundgard.com/projects/transclusion/license */
!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.transclusion=b()}(this,function(){var transclusion=exports.transclusion={};transclusion.elementRules={globalAttrs:{accesskey:[],"class":[],contenteditable:[],contextmenu:[],dir:[],draggable:[],dropzone:[],hidden:[],id:[],itemid:[],itemprop:[],itemref:[],itemscope:[],itemtype:[],lang:[],spellcheck:[],style:[],tabindex:[],title:[]},voidElements:["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],html:{allowedChildElements:{head:[],body:[]},allowedMetaAttrs:{scripts:[],"style-sheets":[],description:[],keywords:[],author:[],charset:[],"application-name":[],generator:[]}},head:{allowedAttrs:{profile:[]},allowedMetaAttrs:{},allowedChildElements:{title:[],base:{allowedAttrs:{href:[],target:[]}},link:{allowedAttrs:{crossorigin:[],disabled:[],href:[],hreflang:[],media:[],methods:[],rel:[],sizes:[],target:[],type:[]}},meta:{allowedAttrs:{charset:["utf-8"],content:[],"http-equiv":[],name:[]}},style:{allowedAttrs:{type:[],media:[],scoped:[],title:[],disabled:[]}},script:{allowedAttrs:{async:[],src:[],type:[],defer:[],crossorigin:[]}},noscript:[]}},body:{allowedAttrs:{onafterprint:[]},allowedMetaAttrs:{},allowedChildElements:{script:{allowedAttrs:{async:[],src:[],type:[],defer:[],crossorigin:[]}},noscript:[],section:{allowedChildElements:{"#flow":[],flink:[]}},nav:{allowedChildElements:{"#flow":[]}},article:{allowedChildElements:{"#flow":[]}},aside:{allowedChildElements:{"#flow":[]}},h1:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},h2:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},h3:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},h4:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},h5:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},h6:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},header:{allowedChildElements:{"#flow":[]}},footer:{allowedChildElements:{"#flow":[]}},address:[],main:{allowedChildElements:{"#flow":[]}},p:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},hr:{allowedAttrs:{color:[]}},pre:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},blockquote:{allowedAttrs:{cite:[]},allowedChildElements:{"#flow":[]}},ol:{allowedAttrs:{reversed:[],start:[],type:[]},allowedChildElements:{li:[]}},ul:{allowedChildElements:{li:[]}},li:{allowedAttrs:{value:[]},allowedChildElements:{"#flow":[]}},dl:{allowedChildElements:{dd:[],dt:[]},allowedAttrs:{compact:[]}},dt:[],dd:{allowedAttrs:{nowrap:[]}},figure:{allowedChildElements:{"#flow":[],figcaption:[]}},figcaption:[],div:{allowedChildElements:{"#flow":[]}},a:{allowedAttrs:{datafld:[],datasrc:[],download:[],href:[],hreflang:[],media:[],methods:[],ping:[],rel:[],target:[],type:[],urn:[]},allowedChildElements:{"#flow":[],"#phrasing":[],a:[],del:[],ins:[],map:[]}},em:[],strong:[],small:[],s:[],cite:[],q:{allowedAttrs:{cite:[]}},dfn:[],abbr:[],data:{allowedAttrs:{value:[]}},time:{allowedAttrs:{datetime:[]}},code:[],"var":[],samp:[],kbd:[],sub:[],sup:[],i:[],b:[],u:[],mark:[],ruby:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},rt:[],rp:[],bdi:[],bdo:{allowedAttrs:{dir:[]}},span:[],br:{allowedAttrs:{clear:[]},allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},wbr:[],ins:{allowedAttrs:{cite:[],datetime:[]}},del:{allowedAttrs:{cite:[],datetime:[]}},img:{allowedAttrs:{alt:[],crossorigin:[],height:[],ismap:[],src:[],width:[],usemap:[]}},iframe:{allowedAttrs:{allowfullscreen:[],height:[],mozapp:[],mozbrowser:[],name:[],remote:[],sandbox:[],seamless:[],src:[],srcdoc:[],width:[]}},embed:{allowedAttrs:{height:[],src:[],type:[],width:[]}},object:{allowedChildElements:{param:[],"#transparent":[]},allowedAttrs:{data:[],form:[],height:[],name:[],type:[],width:[]}},param:{allowedAttrs:{name:[],value:[]}},video:{allowedChildElements:{"#transparent":[],source:[],"#flow":[],"#phrasing":[],a:[],del:[],ins:[],map:[]},allowedAttrs:{autoplay:[],buffered:[],controls:[],crossorigin:[],height:[],loop:[],muted:[],played:[],preload:[],poster:[],src:[],width:[]}},audio:{allowedChildElements:{track:[],"#transparent":[],source:[]},allowedAttrs:{autoplay:[],buffered:[],controls:[],loop:[],mozcurrentsampleoffset:[],muted:[],played:[],preload:[],src:[],volume:[]}},source:{allowedAttrs:{src:[],type:[],media:[]}},track:{allowedAttrs:{"default":[],kind:[],label:[],src:[],srclang:[]}},canvas:{allowedAttrs:{width:[],height:[]}},map:{allowedChildElements:{"#transparent":[]}},area:{allowedAttrs:{alt:[],coords:[],download:[],href:[],hreflang:[],media:[],rel:[],shape:[],target:[],type:[]}},svg:{allowedAttrs:{version:[],baseprofile:[],contentscripttype:[],contentstyletype:[],x:[],y:[],width:[],height:[],viewbox:[],preserveaspectratio:[],zoomandpan:[],"xmlxml:space":[]}},math:{allowedAttrs:{dir:[],href:[],mathbackground:[],mathcolor:[],display:[],overflow:[],decimalpoint:[],displaystyle:[],infixlinebreakstyle:[],scriptlevel:[],scriptminsize:[],scriptsizemultiplier:[]}},table:{allowedChildElements:{caption:[],colgroup:[],thead:[],tfoot:[],tbody:[],tr:[]}},caption:[],colgroup:{allowedChildElements:{col:[]},allowedAttrs:{bgcolor:[],span:[]}},col:{allowedAttrs:{bgcolor:[],span:[]}},tbody:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},thead:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},tfoot:{allowedChildElements:{tr:[]},allowedAttrs:{bgcolor:[]}},tr:{allowedChildElements:{td:[],th:[]}},td:{allowedAttrs:{bgcolor:[],colspan:[],headers:[],rowspan:[]}},th:{allowedAttrs:{bgcolor:[],colspan:[],headers:[],rowspan:[],scope:[]}},form:{allowedChildElements:{"#flow":[]},allowedAttrs:{"accept-charset":[],action:[],autocomplete:[],enctype:[],method:[],name:[],novalidate:[],target:[]}},fieldset:{allowedChildElements:{legend:[],"#flow":[]},allowedAttrs:{disabled:[],form:[],name:[]}},legend:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},label:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]},allowedAttrs:{accesskey:[],"for":[],form:[]}},input:{allowedAttrs:{type:[],accept:[],mozactionhint:[],autocomplete:[],autofocus:[],autosave:[],checked:[],disabled:[],form:[],formaction:[],formenctype:[],formmethod:[],formnovalidate:[],formtarget:[],height:[],inputmode:[],list:[],max:[],maxlength:[],min:[],multiple:[],name:[],pattern:[],placeholder:[],readonly:[],required:[],selectiondirection:[],size:[],spellcheck:[],src:[],step:[],value:[],width:[],"x-moz-errormessage":[]}},button:{allowedAttrs:{autofocus:[],disabled:[],form:[],formaction:[],formenctype:[],formmethod:[],formnovalidate:[],formtarget:[],name:[],type:[],value:[]},allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[]}},select:{allowedChildElements:{option:[],optgroup:[]},allowedAttrs:{autofocus:[],disabled:[],form:[],multiple:[],name:[],required:[],size:[]}},datalist:{allowedChildElements:{"#phrasing":[],a:[],del:[],ins:[],map:[],option:[]}},optgroup:{allowedChildElements:{option:[]},allowedAttrs:{disabled:[],label:[]}},option:{allowedAttrs:{disabled:[],label:[],selected:[],value:[]}},textarea:{allowedAttrs:{autofocus:[],cols:[],disabled:[],form:[],maxlength:[],name:[],placeholder:[],readonly:[],required:[],rows:[],selectiondirection:[],selectionend:[],selectionstart:[],spellcheck:[],wrap:[]}},keygen:{allowedAttrs:{autofocus:[],challenge:[],disabled:[],form:[],keytype:[],name:[]}},output:{allowedAttrs:{"for":[],form:[],name:[]}},progress:{allowedAttrs:{max:[],value:[]}},meter:{allowedAttrs:{value:[],min:[],max:[],low:[],high:[],optimum:[],form:[]}},details:{allowedChildElements:{summary:[],"#flow":[]},allowedAttrs:{open:[]}},summary:[],menuitem:{allowedAttrs:{checked:[],command:[],"default":[],disabled:[],icon:[],label:[],radiogroup:[],type:[]}},menu:{allowedChildElements:{"#flow":[],menuitem:[]},allowedAttrs:{type:[],label:[]}}}},contentCategories:{"#flow":{a:[],abbr:[],address:[],article:[],aside:[],audio:[],b:[],bdo:[],blockquote:[],br:[],button:[],canvas:[],cite:[],code:[],command:[],datalist:[],del:[],details:[],dfn:[],div:[],dl:[],em:[],embed:[],fieldset:[],figure:[],footer:[],form:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hgroup:[],hr:[],i:[],iframe:[],img:[],input:[],ins:[],kbd:[],keygen:[],label:[],main:[],map:[],mark:[],math:[],menu:[],meter:[],nav:[],noscript:[],object:[],ol:[],output:[],p:[],pre:[],progress:[],q:[],ruby:[],s:[],samp:[],script:[],section:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],table:[],textarea:[],time:[],u:[],ul:[],"var":[],video:[],wbr:[],"#text":[]},"#phrasing":{abbr:[],audio:[],b:[],bdi:[],bdo:[],br:[],button:[],canvas:[],cite:[],code:[],command:[],datalist:[],dfn:[],em:[],embed:[],i:[],iframe:[],img:[],input:[],kbd:[],keygen:[],label:[],mark:[],math:[],meter:[],noscript:[],object:[],output:[],progress:[],q:[],ruby:[],samp:[],script:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],textarea:[],time:[],"var":[],video:[],wbr:[],"#text":[]},"#palpable":{a:[],abbr:[],address:[],article:[],aside:[],audio:[],b:[],bdi:[],bdo:[],blockquote:[],button:[],canvas:[],cite:[],code:[],data:[],details:[],dfn:[],div:[],dl:[],em:[],embed:[],fieldset:[],figure:[],footer:[],form:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hgroup:[],i:[],iframe:[],img:[],input:[],ins:[],kbd:[],keygen:[],label:[],main:[],map:[],mark:[],math:[],menu:[],meter:[],nav:[],object:[],ol:[],output:[],p:[],pre:[],progress:[],q:[],ruby:[],s:[],samp:[],section:[],select:[],small:[],span:[],strong:[],sub:[],sup:[],svg:[],table:[],textarea:[],time:[],u:[],ul:[],"var":[],video:[],"#text":[]}}};function ElementDirective(a,b,c){this.name=a,this.rules=b||{},this.callbacks=c||{},this.isLoaded=!1}transclusion.ElementDirective=ElementDirective,ElementDirective.prototype={mayContain:function(a){return this.loadRules(),void 0!==this.rules.allowedChildElements[a]},mayContainAttribute:function(a){return"data-"===a.substr(0,5)?!0:(this.loadRules(),void 0!==this.rules.allowedAttrs[a])},mayContainMetaAttribute:function(a){return this.loadRules(),void 0!==this.rules.allowedMetaAttrs[a]},isVoidElement:function(){return this.loadRules(),-1<transclusion.elementRules.voidElements.indexOf(this.name)},loadRules:function(){var a,b,c,d,e;if(!this.isLoaded){switch(b={},c={},d={},e={},this.name){case"html":b=transclusion.elementRules.html.allowedAttrs,c=transclusion.elementRules.html.allowedMetaAttrs,d=transclusion.elementRules.html.allowedChildElements;break;case"head":b=transclusion.elementRules.head.allowedAttrs,c=transclusion.elementRules.html.allowedMetaAttrs,d=transclusion.elementRules.head.allowedChildElements;break;case"body":b=transclusion.elementRules.body.allowedAttrs,c=transclusion.elementRules.html.allowedMetaAttrs,d=transclusion.elementRules.body.allowedChildElements;break;default:transclusion.elementRules.head.allowedChildElements[this.name]?a=transclusion.elementRules.head.allowedChildElements[this.name]||{}:transclusion.elementRules.body.allowedChildElements[this.name]&&(a=transclusion.elementRules.body.allowedChildElements[this.name]||{}),b=a&&a.allowedAttrs?a.allowedAttrs:{},d=a&&a.allowedChildElements?a.allowedChildElements:{},a&&a.allowedChildElements&&(e=expandChildElements(a.allowedChildElements))}this.extendAllowedAttrs(transclusion.elementRules.globalAttrs),this.extendAllowedAttrs(b),this.extendAllowedMetaAttrs(c),this.extendAllowedChildElements(d),this.extendAllowedChildElements(e),this.isLoaded=!0}},extendAllowedMetaAttrs:function(a){this.rules.allowedMetaAttrs||(this.rules.allowedMetaAttrs={});for(var b in a)this.rules.allowedMetaAttrs[b]=a[b]},extendAllowedAttrs:function(a){this.rules.allowedAttrs||(this.rules.allowedAttrs={});for(var b in a)this.rules.allowedAttrs[b]=a[b]},extendAllowedChildElements:function(a){this.rules.allowedChildElements||(this.rules.allowedChildElements={});for(var b in a)this.rules.allowedChildElements[b]=a[b]}};function expandChildElements(a){var b,c,d={};for(b in a)if("#"===b.charAt(0))for(c in transclusion.elementRules.contentCategories[b])d[c]=transclusion.elementRules.contentCategories[b][c];return d}function ElementDirectiveSet(a){this.name=a,this.isLoaded=!1,this.set=[]}transclusion.ElementDirectiveSet=ElementDirectiveSet,ElementDirectiveSet.prototype={mayContain:function(a){var b,c;for(this.loadDirectives(),b=0,c=this.set.length;c>b;b++)if(this.set[b].mayContain(a))return!0;return!1},mayContainAttribute:function(a){var b,c;for(this.loadDirectives(),b=0,c=this.set.length;c>b;b++)if(this.set[b].mayContainAttribute(a))return!0;return!1},mayContainMetaAttribute:function(a){var b,c;for(this.loadDirectives(),b=0,c=this.set.length;c>b;b++)if(this.set[b].mayContainMetaAttribute(a))return!0;return!1},isVoidElement:function(){var a,b;for(this.loadDirectives(),a=0,b=this.set.length;b>a;a++)if(this.set[a].isVoidElement())return!0;return!1},loadDirectives:function(){this.isLoaded||(this.add(new transclusion.ElementDirective(this.name)),this.isLoaded=!0)},add:function(a){this.set.push(a)}};function Node(a,b){if(this.type=a,this.name=b,this.document=null,this.firstChild=null,this.lastChild=null,this.childNodes=[],this.attrs=[],this.metaAttrs=[],this.index=0,this.parentNode=null,this.childCount=0,this.outerStartOffset=null,this.outerEndOffset=null,this.innerStartOffset=null,this.innerEndOffset=null,!this.name)throw new Error("Missing `name`");if(!this.type)throw new Error("Missing `type`")}transclusion.Node=Node,transclusion.nodes={},Node.NODE_ELEMENT=1,Node.NODE_DOCUMENT=2,Node.NODE_TEXT=3,Node.NODE_ATTR=4,Node.NODE_EXPR=5,Node.NODE_COMMENT=6,Node.NODE_ARRAY=7,Node.NODE_STRING=8,Node.NODE_EXPR=9,Node.NODE_VAR=10,Node.NODE_OPERATOR=11,Node.NODE_NUMBER=12,Node.prototype={setDocument:function(a){this.document=a},appendChild:function(a){return a.parentNode=this,Node.NODE_TEXT?a.whiteSpace||(a.index=this.childCount,this.childCount++):(a.index=this.childCount,this.childCount++),this.childNodes.push(a),this.firstChild||(this.firstChild=a),this.lastChild=a,a},getAttribute:function(a){var b,c;for(b=0,c=this.attrs.length;c>b;b++)if(a===this.attrs[b].name)return this.attrs[b];return null},getMetaAttribute:function(a){var b,c;for(b=0,c=this.metaAttrs.length;c>b;b++)if(a===this.metaAttrs[b].name)return this.metaAttrs[b];return null},appendAttr:function(a){return a.parentNode=this,a.index=this.attrs.length,this.attrs.push(a),a},appendMetaAttr:function(a){return a.parentNode=this,a.index=this.metaAttrs.length,this.metaAttrs.push(a),a},setOuterStartOffset:function(a){if(void 0===a)throw new Error("Argument to `setOuterStartOffset` cannot be undefined");this.outerStartOffset=Number(a)},setOuterEndOffset:function(a){if(void 0===a)throw new Error("Argument to `setOuterEndOffset` cannot be undefined");this.outerEndOffset=Number(a)},setInnerStartOffset:function(a){if(void 0===a)throw new Error("Argument to `setInnerStartOffset` cannot be undefined");this.innerStartOffset=Number(a)},setInnerEndOffset:function(a){if(void 0===a)throw new Error("Argument to `setInnerEndOffset` cannot be undefined");this.innerEndOffset=Number(a)},dump:function(){var a={},b,c;if(a.index=this.index,a.name=this.name,a.type=this.type,this.childNodes.length)for(a.childNodes=[],b=0,c=this.childNodes.length;c>b;b++)a.childNodes.push(this.childNodes[b].dump());return a}};function Element(a){transclusion.Node.call(this,transclusion.Node.NODE_ELEMENT,a),this.directiveSet=null,this.id=null,this.previousSibling=null,this.nextSibling=null}Element.prototype=Object.create(transclusion.Node.prototype),Element.prototype.constructor=Element,transclusion.nodes.Element=Element,Element.prototype.appendChild=function(a){return this.lastChild&&(a.previousSibling=this.lastChild,this.nextSibling=a),a.nextSibling=null,transclusion.Node.prototype.appendChild.call(this,a),a},Element.prototype.mayContain=function(a){return this.getDirectiveSet().mayContain(a)},Element.prototype.mayContainAttribute=function(a){return this.getDirectiveSet().mayContainAttribute(a)},Element.prototype.mayContainMetaAttribute=function(a){return this.getDirectiveSet().mayContainMetaAttribute(a)},Element.prototype.isVoidElement=function(){return this.getDirectiveSet().isVoidElement()},Element.prototype.getDirectiveSet=function(){return null===this.directiveSet&&(this.directiveSet=new transclusion.ElementDirectiveSet(this.name)),this.directiveSet},Element.prototype.dump=function(){var a,b,c=transclusion.Node.prototype.dump.call(this);if(this.attrs.length)for(c.attrs={},a=0,b=this.attrs.length;b>a;a++)c.attrs[this.attrs[a].name]=this.attrs[a].dump();if(this.metaAttrs.length)for(c.metaAttrs={},a=0,b=this.metaAttrs.length;b>a;a++)c.metaAttrs[this.metaAttrs[a].name]=this.metaAttrs[a].dump();return c.outerStartOffset=this.outerStartOffset,c.innerStartOffset=this.innerStartOffset,c.innerEndOffset=this.innerEndOffset,c.outerEndOffset=this.outerEndOffset,c.path=this.getUniquePath(),c},Element.prototype.getUniquePath=function(){if("html"===this.name)return"html";var a,b=this;while(b.parentNode&&"html"!==b.parentNode.name){var c=b.name,d=b.parentNode,e=d.getChildrenByName(c);"body"!==c&&"head"!==c&&e.length>1&&(c+=":nth-child("+(b.index+1)+")"),a=c+(a?">"+a:""),b=d}return a},Element.prototype.getChildrenByName=function(a){for(var b=[],c=0;c<this.childNodes.length;c++)a===this.childNodes[c].name&&b.push(this.childNodes[c]);return b};function Attr(a){transclusion.Node.call(this,transclusion.Node.NODE_ATTR,a)}Attr.prototype=Object.create(transclusion.Node.prototype),Attr.prototype.constructor=Attr,transclusion.nodes.Attr=Attr,Attr.prototype.evaluate=function(){return this.document.getCompiler().compileNodes(this.childNodes)};function Text(a){transclusion.Node.call(this,transclusion.Node.NODE_TEXT,"#text"),this.data=a||"",this.whiteSpace=!0}Text.prototype=Object.create(transclusion.Node.prototype),Text.prototype.constructor=Text,transclusion.nodes.Text=Text,Text.prototype.appendData=function(a){this.data+=a},Text.prototype.dump=function(){var a=transclusion.Node.prototype.dump.call(this);return a.data=this.data,a};function Comment(a){transclusion.Node.call(this,transclusion.Node.NODE_COMMENT,"#comment"),this.data=a||""}Comment.prototype=Object.create(transclusion.Node.prototype),Comment.prototype.constructor=Comment,transclusion.nodes.Comment=Comment,Comment.prototype.dump=function(){var a=transclusion.Node.prototype.dump.call(this);return a.data=this.data,a};function Arr(){transclusion.Node.call(this,transclusion.Node.NODE_ARRAY,"#array")}Arr.prototype=Object.create(transclusion.Node.prototype),Arr.prototype.constructor=Arr,transclusion.nodes.Arr=Arr,Arr.prototype.dump=function(){var a=transclusion.Node.prototype.dump.call(this);return a};function Expr(){transclusion.Node.call(this,transclusion.Node.NODE_EXPR,"#expr")}Expr.prototype=Object.create(transclusion.Node.prototype),Expr.prototype.constructor=Expr,transclusion.nodes.Expr=Expr;function Var(a){transclusion.Node.call(this,transclusion.Node.NODE_VAR,a)}Var.prototype=Object.create(transclusion.Node.prototype),Var.prototype.constructor=Var,transclusion.nodes.Var=Var;function Operator(a){transclusion.Node.call(this,transclusion.Node.NODE_OPERATOR,"#operator"),this.sign=a}Operator.prototype=Object.create(transclusion.Node.prototype),Operator.prototype.constructor=Operator,transclusion.nodes.Operator=Operator,Operator.prototype.dump=function(){var a=transclusion.Node.prototype.dump.call(this);return a.sign=this.sign,a};function Str(a){transclusion.Node.call(this,transclusion.Node.NODE_STRING,"#string"),this.data=a}Str.prototype=Object.create(transclusion.Node.prototype),Str.prototype.constructor=Str,transclusion.nodes.Str=Str,Str.prototype.dump=function(){var a=transclusion.Node.prototype.dump.call(this);return a.data=this.data,a};function Num(a){transclusion.Node.call(this,transclusion.Node.NODE_NUMBER,"#number"),this.value=a}Num.prototype=Object.create(transclusion.Node.prototype),Num.prototype.constructor=Num,transclusion.nodes.Num=Num;function CharStream(a){this.input=a?a.replace(/(\r\n|\n|\r)/gm,"\n"):"",this.size=this.input.length,this.pointer=0,this.line=1,this.column=1}transclusion.CharStream=CharStream,CharStream.prototype={getPointer:function(){return this.pointer},getSize:function(){return this.size},getLine:function(){return this.line},getColumn:function(){return this.column},consume:function(a){var b="",c,d=0;void 0===a&&(a=1);while(a>d)this.pointer<this.getSize()&&(c=this.input.charAt(this.pointer),"\n"===c&&(this.line++,this.column=0),b+=c,this.column++,this.pointer++),d++;return b.length?b:-1},next:function(a){var b="",c=0;void 0===a&&(a=1);while(a>c)this.pointer+c<this.getSize()&&(b+=this.input.charAt(this.pointer+c)),c++;return 0===b.length?-1:b},shift:function(a){var b=0,c;void 0===a&&(a=1);while(a>b)c=this.next(),"\n"===c&&(this.line++,this.column=0),this.column++,this.pointer++,b++}},transclusion.CharTester={isWhiteSpace:function(a){return"\n"===a||"	"===a||" "===a},isUpperCase:function(a){return a>="A"&&"Z">=a},isLowerCase:function(a){return a>="a"&&"z">=a},isNumber:function(a){return a>="0"&&"9">=a},isAlpha:function(a){return this.isUpperCase(a)||this.isLowerCase(a)}};function Document(a){transclusion.Node.call(this,transclusion.Node.NODE_DOCUMENT,"#document"),this.debug=!1,this.input=a||"",this.parser=null,this.compiler=null,this.directives=[],this.reset()}Document.prototype=Object.create(transclusion.Node.prototype),Document.prototype.constructor=Document,transclusion.Document=Document,Document.prototype.addDirective=function(a,b){var c=new transclusion.ElementDirective(a,b);return this.directives.push(c),c},Document.prototype.setInput=function(a){a!==this.input&&(this.input=a,this.reset())},Document.prototype.reset=function(){this.parser&&this.parser.reset(),this.context={test:"Hello, world!"},this.childNodes=[],this.attrs=[],this.firstChild=null,this.lastChild=null,this.outerStartOffset=null,this.outerEndOffset=null,this.innerStartOffset=null,this.innerEndOffset=null,this.documentElement=null,this.titleElement=null,this.body=null,this.isParsed=!1,this.isCompiled=!1,this.output=null},Document.prototype.createElement=function(a){var b=new transclusion.nodes.Element(a);switch(b.setDocument(this),a){case"html":if(this.documentElement)throw new Error("The <html> element already exists");this.documentElement=b;break;case"body":if(this.body)throw new Error("The <body> element already exists");this.body=b;break;case"title":if(this.titleElement)throw new Error("The <title> element already exists");this.titleElement=b}return b},Document.prototype.createText=function(a){var b=new transclusion.nodes.Text(a);return b.setDocument(this),b},Document.prototype.createComment=function(a){var b=new transclusion.nodes.Comment(a);return b.setDocument(this),b},Document.prototype.createAttr=function(a){var b=new transclusion.nodes.Attr(a);return b.setDocument(this),b},Document.prototype.createArray=function(a){var b=new transclusion.nodes.Arr(a);return b.setDocument(this),b},Document.prototype.createString=function(a){var b=new transclusion.nodes.Str(a);return b.setDocument(this),b},Document.prototype.createExpr=function(){var a=new transclusion.nodes.Expr;return a.setDocument(this),a},Document.prototype.createVar=function(a){var b=new transclusion.nodes.Var(a);return b.setDocument(this),b},Document.prototype.createNumber=function(a){var b=new transclusion.nodes.Num(a);return b.setDocument(this),b},Document.prototype.createOperator=function(a){var b=new transclusion.nodes.Operator(a);return b.setDocument(this),b},Document.prototype.getParser=function(){return null===this.parser&&(this.parser=new transclusion.Parser(this)),this.parser},Document.prototype.getCompiler=function(){return null===this.compiler&&(this.compiler=new transclusion.Compiler(this)),this.compiler},Document.prototype.parse=function(){this.isParsed||(this.getParser().parse(this.input),this.isParsed=!0)},Document.prototype.compile=function(a){return a&&this.setInput(a),this.isCompiled||(this.parse(),this.output=this.getCompiler().compile(),this.isCompiled=!0),this.output},transclusion.Token={EOF:"EOF",CHAR:"CHAR",DOCTYPE:"DOCTYPE",COMMENT:"COMMENT",START_TAG:"START_TAG",START_TAG_CLOSE:"START_TAG_CLOSE",START_TAG_NAME:"START_TAG_NAME",END_TAG:"END_TAG",ATTR_KEY:"ATTR_KEY",START_ATTR_VALUE:"START_ATTR_VALUE",END_ATTR_VALUE:"END_ATTR_VALUE",START_EXPR:"START_EXPR",VAR:"VAR",FUNC:"FUNC",END_FUNC:"END_FUNC",DOT:"DOT",STR:"STR",NUM:"NUM",END_EXPR:"END_EXPR",OPERATOR:"OPERATOR",META:"META",END_META:"END_META",START_ARR:"START_ARR",END_ARR:"END_ARR",START_OBJ:"START_OBJ",END_OBJ:"END_OBJ"};function Tokenizer(a){if(!a)throw new Error("Missing `parser` for Tokenizer");this.parser=a,this.reset(),this.openExprDelim="[[",this.closeExprDelim="]]",this.replacementChar="?"}transclusion.Tokenizer=Tokenizer,Tokenizer.STATE_EOF="STATE_EOF",Tokenizer.STATE_DATA="STATE_DATA",Tokenizer.STATE_MARKUP_DECLARATION_OPEN="STATE_MARKUP_DECLARATION_OPEN",Tokenizer.STATE_COMMENT_START="STATE_COMMENT_START",Tokenizer.STATE_COMMENT_START_DASH="STATE_COMMENT_START_DASH",Tokenizer.STATE_COMMENT="STATE_COMMENT",Tokenizer.STATE_COMMENT_END_DASH="STATE_COMMENT_END_DASH",Tokenizer.STATE_COMMENT_END="STATE_COMMENT_END",Tokenizer.STATE_BOGUS_COMMENT="STATE_BOGUS_COMMENT",Tokenizer.STATE_CHAR_REF_IN_DATA="STATE_CHAR_REF_IN_DATA",Tokenizer.STATE_TAG_OPEN="STATE_TAG_OPEN",Tokenizer.STATE_TAG_NAME="STATE_TAG_NAME",Tokenizer.STATE_SELF_CLOSING_START_TAG="STATE_SELF_CLOSING_START_TAG",Tokenizer.STATE_BEFORE_ATTR_KEY="STATE_BEFORE_ATTR_KEY",Tokenizer.STATE_END_TAG_OPEN="STATE_END_TAG_OPEN",Tokenizer.STATE_END_TAG_NAME="STATE_END_TAG_NAME",Tokenizer.STATE_RAWTEXT="STATE_RAWTEXT",Tokenizer.STATE_RAWTEXT_LESS_THAN_SIGN="STATE_RAWTEXT_LESS_THAN_SIGN",Tokenizer.STATE_RAWTEXT_END_TAG_OPEN="STATE_RAWTEXT_END_TAG_OPEN",Tokenizer.STATE_RAWTEXT_END_TAG_NAME="STATE_RAWTEXT_END_TAG_NAME",Tokenizer.STATE_BEFORE_ATTR_KEY="STATE_BEFORE_ATTR_KEY",Tokenizer.STATE_ATTR_KEY="STATE_ATTR_KEY",Tokenizer.STATE_BEFORE_ATTR_VALUE="STATE_BEFORE_ATTR_VALUE",Tokenizer.STATE_ATTR_VALUE="STATE_ATTR_VALUE",Tokenizer.STATE_AFTER_ATTR_VALUE="STATE_AFTER_ATTR_VALUE",Tokenizer.STATE_BEFORE_ARRAY_VALUE="STATE_BEFORE_ARRAY_VALUE",Tokenizer.STATE_BEFORE_OBJECT_KEY="STATE_BEFORE_OBJECT_KEY",Tokenizer.STATE_ARRAY_STRING_ESCAPED_VALUE="STATE_ARRAY_STRING_ESCAPED_VALUE",Tokenizer.STATE_AFTER_ARRAY_VALUE="STATE_AFTER_ARRAY_VALUE",Tokenizer.STATE_DYNAMIC_STRING_VALUE="STATE_DYNAMIC_STRING_VALUE",Tokenizer.STATE_DYNAMIC_NUMBER_VALUE="STATE_DYNAMIC_NUMBER_VALUE",Tokenizer.STATE_DYNAMIC_NUMBER_VALUE_AFTER_DECIMAL="STATE_DYNAMIC_NUMBER_VALUE_AFTER_DECIMAL",Tokenizer.STATE_EXPR="STATE_EXPR",Tokenizer.STATE_EXPR_VAR="STATE_EXPR_VAR",Tokenizer.STATE_EXPR_AFTER_VALUE="STATE_EXPR_AFTER_VALUE",Tokenizer.STATE_EXPR_AFTER_OPERATOR="STATE_EXPR_AFTER_OPERATOR";var exprStates=[Tokenizer.STATE_EXPR,Tokenizer.STATE_EXPR_VAR,Tokenizer.STATE_EXPR_AFTER_VALUE,Tokenizer.STATE_EXPR_AFTER_OPERATOR],state={},Token=transclusion.Token,CharTester=transclusion.CharTester;Tokenizer.prototype={reset:function(){this.queueTokens=!1,this.tokQueue=[],this.stateStack=[],this.state=Tokenizer.STATE_DATA,this.tok=null,this.buffer="",this.prevStartTagToken=null,this.attrDelimiter=null},tokenize:function(a){var b=new transclusion.CharStream(a),c=0;while(!0){if(this.parser.document.debug&&this.parser.debug(this.state+".tokenize("+b.next()+")"),void 0===state[this.state])throw new Error("Unexpected tokenizer state: "+this.state);if(state[this.state](this,b),c++,this.parser.document.debug&&c>3e3)throw new Error("Tokenizer running wild?");if(Tokenizer.STATE_EOF===this.state)return}if(Tokenizer.STATE_EOF!==this.state)throw new Error("The tokenizer did not finish (state was "+this.state+", but should be STATE_EOF)")},emit:function(a){if(a||(a=this.tok,this.tok=null),this.tok)throw new Error("The tokenizer has an unemitted token");Token.START_TAG===a.type&&(this.prevStartTagToken=a),this.queueTokens?this.tokQueue.push(a):this.parser.handleToken(a)},releaseTokenQueue:function(){var a,b;for(this.queueTokens=!1,a=0,b=this.tokQueue.length;b>a;a++)this.emit(this.tokQueue[a]);this.tokQueue=[]},exitExpr:function(){this.buffer="",this.tokQueue=[],this.queueTokens=!1;while(-1<exprStates.indexOf(this.state))this.popState();this.tok=null,this.emit({type:Token.CHAR,data:this.buffer})},currentEndTagIsAppropriate:function(){if(Token.END_TAG!==this.tok.type)throw new Error("The current token is not an end tag: "+this.tok.type);return this.prevStartTagToken&&this.tok.name===this.prevStartTagToken.name},setState:function(a){if(void 0===a)throw new Error("Cannot set undefined state");this.state=a},pushState:function(a){this.stateStack.push(this.state),this.state=a},popState:function(){if(!this.stateStack.length)throw new Error("The state stack cannot be popped because it's already empty");this.state=this.stateStack.pop()}},state[Tokenizer.STATE_DATA]=function(a,b){var c=b.consume();switch(!0){case"&"===c:a.setState(Tokenizer.STATE_CHAR_REF_IN_DATA);break;case"<"===c:a.setState(Tokenizer.STATE_TAG_OPEN);break;case-1===c:a.setState(Tokenizer.STATE_EOF),a.emit({type:Token.EOF});break;case a.openExprDelim===c+b.next(a.openExprDelim.length-1):a.queueTokens=!0,a.emit({type:Token.START_EXPR,offset:b.getPointer()-1}),b.shift(a.openExprDelim.length-1),a.buffer=a.openExprDelim,a.pushState(Tokenizer.STATE_EXPR);break;case"\x00"===c:a.parser.report("exception","Unexpected NULL character (STATE_DATA)"),a.emit({type:Token.CHAR,data:a.replacementChar});break;default:a.emit({type:Token.CHAR,data:c})}},state[Tokenizer.STATE_MARKUP_DECLARATION_OPEN]=function(a,b){switch(!0){case"--"===b.next(2):b.shift(2),a.tok={type:Token.COMMENT,data:""},a.setState(Tokenizer.STATE_COMMENT_START);break;case"DOCTYPE"===String(b.next(7)).toUpperCase():b.shift(7),a.setState(Tokenizer.STATE_DOCTYPE);break;default:var c=b.next();a.parser.report("error","Unexpected character: "+c+" (STATE_MARKUP_DECLARATION_OPEN)"),a.setState(Tokenizer.STATE_BOGUS_COMMENT),-1!==c&&(a.buffer=c)}},state[Tokenizer.STATE_COMMENT_START]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(Tokenizer.STATE_COMMENT_START_DASH);break;case"\x00"===c:b.consume(),a.parser.report("error","Unexpected NULL character (STATE_COMMENT_START)"),a.tok.data+=a.replacementChar;break;case">"===c:b.consume(),a.parser.report("error","Unexpected > character (STATE_COMMENT_START)"),a.setState(Tokenizer.STATE_DATA),a.emit();break;case-1===c:a.parser.report("error","Unexpected EOF (STATE_COMMENT_START)"),a.setState(Tokenizer.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+=c,a.setState(Tokenizer.STATE_COMMENT)}},state[Tokenizer.STATE_COMMENT_START_DASH]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(Tokenizer.STATE_COMMENT_END);break;case"\x00"===c:b.consume(),a.parser.report("error","Unexpected NULL character in STATE_COMMENT_START_DASH"),a.tok.data+="-"+a.replacementChar,a.setState(Tokenizer.STATE_COMMENT);break;case">"===c:b.consume(),a.parser.report("error","Unexpected > character in STATE_COMMENT_START_DASH"),a.setState(Tokenizer.STATE_DATA),a.emit();break;case-1===c:a.parser.report("error","Unexpected EOF character in STATE_COMMENT_START_DASH"),a.setState(Tokenizer.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+="-"+c,a.setState(Tokenizer.STATE_COMMENT)}},state[Tokenizer.STATE_COMMENT]=function(a,b){var c=b.next();switch(!0){case"-"===c:b.consume(),a.setState(Tokenizer.STATE_COMMENT_END_DASH);break;case"\x00"===c:b.consume(),a.parser.report("error","Encountered NULL character (STATE_COMMENT)"),a.tok.data+=a.replacementChar;break;case-1===c:a.parser.report("error","Encountered EOF (STATE_COMMENT)"),a.setState(Tokenizer.STATE_DATA),a.emit();break;default:b.consume(),a.tok.data+=c}},state[Tokenizer.STATE_COMMENT_END_DASH]=function(a,b){var c=b.consume();switch(!0){case"-"===c:a.setState(Tokenizer.STATE_COMMENT_END);break;default:a.tok.data+=c,a.setState(Tokenizer.STATE_COMMENT)}},state[Tokenizer.STATE_COMMENT_END]=function(a,b){var c=b.consume();switch(!0){case">"===c:a.setState(Tokenizer.STATE_DATA),a.emit();
break;case"\x00"===c:a.parser.report("error","Unexpected NULL character (STATE_COMMENT_END)"),a.tok.data+="--"+a.replacementChar,a.setState(Tokenizer.STATE_COMMENT);break;case"!"===c:a.parser.report("error","Unexpected `!` (STATE_COMMENT_END)"),a.setState(Tokenizer.STATE_COMMENT_END_BANG);break;case"-"===c:a.parser.report("error","Unexpected `-` (STATE_COMMENT_END)"),a.tok.data+="-";break;case-1===c:a.parser.report("error","Unexpected EOF (STATE_COMMENT_END)"),a.setState(Tokenizer.STATE_DATA),a.emit();break;default:a.parser.report("error","Unexpected character: "+c+" (STATE_COMMENT_END)"),a.tok.data+="--"+c,a.setState(Tokenizer.STATE_COMMENT)}},state[Tokenizer.STATE_BOGUS_COMMENT]=function(a,b){var c="",d="";while(">"!==c&&-1!==c)c=b.consume(),-1!==c&&(d+="\x00"===c?a.replacementChar:c);b.consume(),a.emit({type:Token.COMMENT,data:d}),a.setState(Tokenizer.STATE_DATA)},state[Tokenizer.STATE_TAG_OPEN]=function(a,b){var c=b.consume();switch(!0){case"!"===c:a.setState(Tokenizer.STATE_MARKUP_DECLARATION_OPEN);break;case"/"===c:a.setState(Tokenizer.STATE_END_TAG_OPEN);break;case">"===c:a.emit({type:Token.CHAR,data:"<>"}),a.setState(Tokenizer.STATE_DATA);break;case"<"===c:a.emit({type:Token.CHAR,data:"<"});break;case CharTester.isWhiteSpace(c):a.emit({type:Token.CHAR,data:"<".chr}),a.setState(Tokenizer.STATE_DATA);break;case CharTester.isUpperCase(c):a.tok={type:Token.START_TAG,name:c.toLowerCase(),offset:b.pointer-2},a.setState(Tokenizer.STATE_TAG_NAME);break;case CharTester.isLowerCase(c):a.tok={type:Token.START_TAG,name:c,offset:b.pointer-2},a.setState(Tokenizer.STATE_TAG_NAME);break;case"?"===c:a.parser.report("exception","Unexpected character in tag open: ? (STATE_TAG_OPEN)"),a.setState(Tokenizer.STATE_BOGUS_COMMENT),a.buffer=c;break;case-1===c:a.parser.report("notice","Unexpected EOF in tag open (STATE_TAG_OPEN)"),a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.CHAR,data:"&lt;"});break;default:a.parser.report("notice","Unexpected character in tag open: "+c+" (STATE_TAG_OPEN)"),a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.CHAR,data:"&lt;".chr})}},state[Tokenizer.STATE_TAG_NAME]=function(a,b){var c=b.consume(),d;switch(!0){case CharTester.isUpperCase(c):c=c.toLowerCase(),a.tok.name+=c;break;case CharTester.isLowerCase(c):case CharTester.isNumber(c):a.tok.name+=c;break;case CharTester.isWhiteSpace(c):a.emit(),a.setState(Tokenizer.STATE_BEFORE_ATTR_KEY);break;case">"===c:a.emit(),a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.START_TAG_CLOSE,selfClosing:!1,offset:b.pointer});break;case"/"===c:a.emit(),a.setState(Tokenizer.STATE_SELF_CLOSING_START_TAG);break;case-1===c:a.parser.report("notice","Unexpected EOF in tag name"),d="",a.tok&&(d=a.tok.name),a.tok=null,a.emit({type:Token.CHAR,data:"&lt;"+d}),a.setState(Tokenizer.STATE_DATA);break;default:a.parser.report("notice","Unexpected character in tag name: "+c),d=a.tok.name,a.tok=null,a.emit({type:Token.CHAR,data:"&lt;"+d+c}),a.setState(Tokenizer.STATE_DATA)}},state[Tokenizer.STATE_END_TAG_OPEN]=function(a,b){var c=b.consume();switch(!0){case CharTester.isUpperCase(c):a.tok={type:Token.END_TAG,name:c.toLowerCase(),innerOffset:b.pointer-3},a.setState(Tokenizer.STATE_END_TAG_NAME);break;case CharTester.isLowerCase(c):a.tok={type:Token.END_TAG,name:c,innerOffset:b.pointer-3},a.setState(Tokenizer.STATE_END_TAG_NAME);break;case-1===c:a.emit({type:Token.CHAR,data:"&lt;/"}),a.setState(Tokenizer.STATE_DATA);break;default:a.parser.report("exception","Unexpected character in end tag open: "+c)}},state[Tokenizer.STATE_END_TAG_NAME]=function(a,b){var c=b.consume(),d;switch(!0){case CharTester.isUpperCase(c):a.tok.name+=c.toUpperCase();break;case CharTester.isLowerCase(c):case CharTester.isNumber(c):a.tok.name+=c;break;case">"===c:a.tok.outerOffset=b.pointer,a.emit(),a.setState(Tokenizer.STATE_DATA);break;case-1===c:d=a.tok.name,a.tok=null,a.emit({type:Token.CHAR,data:"&lt;/"+d}),a.setState(Tokenizer.STATE_DATA);break;default:a.parser.report("exception","Unexpected character in end tag name: "+c)}},state[Tokenizer.STATE_RAWTEXT]=function(a,b){var c=b.consume();switch(!0){case"<"===c:a.setState(Tokenizer.STATE_RAWTEXT_LESS_THAN_SIGN);break;case"\x00"===c:a.parser.report("error","Unexpected NULL characted in rawtext (STATE_RAWTEXT)"),a.emit({type:Token.CHAR,data:a.replacementChar});break;case-1===c:a.emit({type:Token.EOF}),a.setState(Tokenizer.STATE_DATA);break;default:a.emit({type:Token.CHAR,data:c})}},state[Tokenizer.STATE_RAWTEXT_LESS_THAN_SIGN]=function(a,b){var c=b.next();switch(!0){case"/"===c:b.consume(),a.buffer="",a.setState(Tokenizer.STATE_RAWTEXT_END_TAG_OPEN);break;default:a.setState(Tokenizer.STATE_RAWTEXT),a.emit({type:Token.CHAR,data:"<"})}},state[Tokenizer.STATE_RAWTEXT_END_TAG_OPEN]=function(a,b){var c=b.next();switch(!0){case CharTester.isUpperCase(c):b.consume(),a.tok={type:Token.END_TAG,name:c.toLowerCase()},a.buffer+=c,a.setState(Tokenizer.STATE_RAWTEXT_END_TAG_NAME);break;case CharTester.isLowerCase(c):b.consume(),a.tok={type:Token.END_TAG,name:c},a.buffer+=c,a.setState(Tokenizer.STATE_RAWTEXT_END_TAG_NAME);break;default:a.setState(Tokenizer.STATE_RAWTEXT),a.emit({type:Token.CHAR,data:"</"})}},state[Tokenizer.STATE_RAWTEXT_END_TAG_NAME]=function(a,b){var c=b.next();switch(!0){case CharTester.isWhiteSpace(c):a.currentEndTagIsAppropriate()?(b.consume(),a.setState(Tokenizer.STATE_BEFORE_ATTR_KEY)):(a.setState(Tokenizer.STATE_RAWTEXT),a.tok=null,a.emit({type:Token.CHAR,data:"</"+a.buffer}));break;case"/"===c:a.currentEndTagIsAppropriate()?(b.consume(),a.setState(Tokenizer.STATE_SELF_CLOSING_START_TAG)):(a.setState(Tokenizer.STATE_RAWTEXT),a.tok=null,a.emit({type:Token.CHAR,data:"</"+a.buffer}));break;case">"===c:a.currentEndTagIsAppropriate()?(b.consume(),a.setState(Tokenizer.STATE_DATA),a.emit()):(a.setState(Tokenizer.STATE_RAWTEXT),a.tok=null,a.emit({type:Token.CHAR,data:"</"+a.buffer}));break;case CharTester.isUpperCase(c):b.consume(),a.tok.name+=c.toLowerCase(),a.buffer+=c;break;case CharTester.isLowerCase(c):b.consume(),a.tok.name+=c,a.buffer+=c;break;default:a.setState(Tokenizer.STATE_RAWTEXT),a.tok=null,a.emit({type:Token.CHAR,data:"</"+a.buffer})}},state[Tokenizer.STATE_BEFORE_ATTR_KEY]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):break;case CharTester.isUpperCase(c):a.tok={type:Token.ATTR_KEY,name:c.toLowerCase()},a.setState(Tokenizer.STATE_ATTR_KEY);break;case CharTester.isLowerCase(c):a.tok={type:Token.ATTR_KEY,name:c},a.setState(Tokenizer.STATE_ATTR_KEY);break;case">"===c:a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.START_TAG_CLOSE,selfClosing:!1,offset:b.pointer});break;case-1===c:a.parser.report("error","Unexpected end of file before attribute key: "+c+" (STATE_BEFORE_ATTR_KEY)"),a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.START_TAG_CLOSE,offset:-1});break;default:a.parser.report("exception","Unexpected character before attribute key: "+c+" (STATE_BEFORE_ATTR_KEY)")}},state[Tokenizer.STATE_ATTR_KEY]=function(a,b){var c=b.consume();switch(!0){case"="===c:a.emit(),a.setState(Tokenizer.STATE_BEFORE_ATTR_VALUE);break;case CharTester.isUpperCase(c):case CharTester.isLowerCase(c):case"-"===c:a.tok.name+=c.toLowerCase();break;case-1===c:a.parser.report("exception","Unexpected end of file before attribute key: "+c+" (STATE_ATTR_KEY)");break;default:a.parser.report("exception","Unexpected character in attribute key: "+c+" (STATE_ATTR_KEY)")}},state[Tokenizer.STATE_BEFORE_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):break;case"["===c:a.emit({type:Token.START_ARR}),a.setState(Tokenizer.STATE_AFTER_ATTR_VALUE),a.pushState(Tokenizer.STATE_BEFORE_ARRAY_VALUE);break;case"{"===c:a.emit({type:Token.START_OBJ}),a.setState(Tokenizer.STATE_AFTER_ATTR_VALUE),a.pushState(Tokenizer.STATE_BEFORE_OBJECT_KEY);break;case'"'===c:case"'"===c:a.attrDelimiter=c,a.emit({type:Token.START_ATTR_VALUE}),a.setState(Tokenizer.STATE_ATTR_VALUE);break;default:a.parser.report("exception","Unexpected character before attribute value: "+c)}},state[Tokenizer.STATE_BEFORE_ARRAY_VALUE]=function(a,b){var c=b.consume();switch(!0){case"]"===c:a.emit({type:Token.END_ARR}),a.popState();break;case"'"===c:case'"'===c:a.tok={type:Token.STR,data:""},a.attrDelimiter=c,a.setState(Tokenizer.STATE_AFTER_ARRAY_VALUE),a.pushState(Tokenizer.STATE_DYNAMIC_STRING_VALUE);break;default:a.parser.report("exception","Unexpected character: "+c+" (STATE_BEFORE_ARRAY_VALUE)")}},state[Tokenizer.STATE_ARRAY_STRING_ESCAPED_VALUE]=function(a,b){var c=b.consume();switch(!0){case-1===c:a.parser.report("exception","Unexpected EOF (STATE_ARRAY_STRING_ESCAPED_VALUE)");break;default:a.tok.data+=c,a.setState(Tokenizer.STATE_DYNAMIC_STRING_VALUE)}},state[Tokenizer.STATE_AFTER_ARRAY_VALUE]=function(a,b){var c=b.consume();switch(!0){case"]"===c:a.emit({type:Token.END_ARR}),a.popState();break;default:a.parser.report("exception","Unexpected character: "+c+" (STATE_AFTER_ARRAY_VALUE)")}},state[Tokenizer.STATE_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case a.attrDelimiter===c:a.emit({type:Token.END_ATTR_VALUE}),a.setState(Tokenizer.STATE_AFTER_ATTR_VALUE);break;case-1===c:a.emit({type:Token.END_ATTR_VALUE}),a.setState(Tokenizer.STATE_AFTER_ATTR_VALUE),a.parser.report("error","Unexpected EOF in attribute value");break;default:a.emit({type:Token.CHAR,data:c})}},state[Tokenizer.STATE_AFTER_ATTR_VALUE]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):a.setState(Tokenizer.STATE_BEFORE_ATTR_KEY);break;case">"===c:a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.START_TAG_CLOSE,selfClosing:!1,offset:b.getPointer()});break;case-1===c:a.setState(Tokenizer.STATE_DATA),a.emit({type:Token.START_TAG_CLOSE,selfClosing:!1,offset:b.getPointer()});break;default:a.parser.report("exception","Unexpected character after attribute value: "+c)}},state[Tokenizer.STATE_EXPR]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):a.buffer+=c;break;case CharTester.isAlpha(c):a.buffer+=c,a.tok={type:Token.VAR,name:c},a.setState(Tokenizer.STATE_EXPR_VAR);break;case"'"===c:case'"'===c:a.buffer+=c,a.tok={type:Token.STR,data:""},a.attrDelimiter=c,a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_DYNAMIC_STRING_VALUE);break;case CharTester.isNumber(c):a.buffer+=c,a.tok={type:Token.NUM,value:c},a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_DYNAMIC_NUMBER_VALUE);break;case"("===c:a.buffer+=c,a.emit({type:Token.START_EXPR,offset:b.getPointer()-1}),a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_EXPR);break;default:a.buffer+=c,a.parser.report("error","Unexpected character: "+c+" (STATE_EXPR)"),a.exitExpr()}},state[Tokenizer.STATE_EXPR_VAR]=function(a,b){var c=b.next();switch(!0){case CharTester.isAlpha(c):case CharTester.isNumber(c):a.buffer+=c,b.consume(),a.tok.name+=c;break;case CharTester.isWhiteSpace(c):a.buffer+=c,b.consume(),a.emit(),a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE);break;case-1===c:a.parser.report("error","Unexpected EOF (STATE_EXPR_VAR)"),a.exitExpr();break;default:a.emit(),a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE)}},state[Tokenizer.STATE_EXPR_AFTER_VALUE]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):a.buffer+=c;break;case"+"===c:case"-"===c:case"*"===c:case"/"===c:a.buffer+=c,a.emit({type:Token.OPERATOR,sign:c}),a.setState(Tokenizer.STATE_EXPR_AFTER_OPERATOR);break;case a.closeExprDelim===c+b.next(a.closeExprDelim.length-1):a.buffer+=a.closeExprDelim,a.emit({type:Token.END_EXPR,offset:b.getPointer()-1}),b.shift(a.closeExprDelim.length-1),a.popState(),a.releaseTokenQueue();break;case")"===c:a.buffer+=c,a.emit({type:Token.END_EXPR,offset:b.getPointer()-1}),a.popState();break;default:a.buffer+=-1===c?"":c,a.parser.report("error","Unexpected character: "+c+" (STATE_EXPR_AFTER_VALUE)"),a.exitExpr()}},state[Tokenizer.STATE_EXPR_AFTER_OPERATOR]=function(a,b){var c=b.consume();switch(!0){case CharTester.isWhiteSpace(c):a.buffer+=c;break;case"'"===c:case'"'===c:a.buffer+=c,a.tok={type:Token.STR,data:""},a.attrDelimiter=c,a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_DYNAMIC_STRING_VALUE);break;case CharTester.isNumber(c):a.buffer+=c,a.tok={type:Token.NUM,value:c},a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_DYNAMIC_NUMBER_VALUE);break;case"("===c:a.buffer+=c,a.emit({type:Token.START_EXPR,offset:b.getPointer()-1}),a.setState(Tokenizer.STATE_EXPR_AFTER_VALUE),a.pushState(Tokenizer.STATE_EXPR);break;default:a.buffer+=-1===c?"":c,a.parser.report("error","Unexpected character: "+c+" (STATE_EXPR_AFTER_OPERATOR)"),a.exitExpr()}},state[Tokenizer.STATE_DYNAMIC_STRING_VALUE]=function(a,b){var c=b.consume();switch(!0){case"\\"===c:a.buffer+=c,a.setState(Tokenizer.STATE_ARRAY_STRING_ESCAPED_VALUE);break;case a.attrDelimiter===c:a.buffer+=c,a.emit(),a.popState();break;case-1===c:a.parser.report("exception","Unexpected EOF (STATE_DYNAMIC_STRING_VALUE)");break;default:a.buffer+=c,a.tok.data+=c}},state[Tokenizer.STATE_DYNAMIC_NUMBER_VALUE]=function(a,b){var c=b.next();switch(!0){case CharTester.isNumber(c):a.buffer+=c,b.shift(1),a.tok.value+=c;break;case"."===c:a.buffer+=c,a.tok.value+=".",b.shift(1),a.setState(Tokenizer.STATE_DYNAMIC_NUMBER_VALUE_AFTER_DECIMAL);break;default:a.emit(),a.popState()}};function TreeConstructor(a){if(!a)throw new Error("Missing `parser` for TreeConstructor");this.parser=a,this.reset()}var Token=transclusion.Token,CharTester=transclusion.CharTester,mode={};transclusion.TreeConstructor=TreeConstructor,TreeConstructor.MODE_INITIAL="MODE_INITIAL",TreeConstructor.MODE_BEFORE_HTML="MODE_BEFORE_HTML",TreeConstructor.MODE_BEFORE_HEAD="MODE_BEFORE_HEAD",TreeConstructor.MODE_IN_HEAD="MODE_IN_HEAD",TreeConstructor.MODE_AFTER_HEAD="MODE_AFTER_HEAD",TreeConstructor.MODE_IN_BODY="MODE_IN_BODY",TreeConstructor.MODE_AFTER_BODY="MODE_AFTER_BODY",TreeConstructor.MODE_AFTER_HTML="MODE_AFTER_HTML",TreeConstructor.MODE_IN_START_TAG="MODE_IN_START_TAG",TreeConstructor.MODE_IN_TEXT="MODE_IN_TEXT",TreeConstructor.MODE_ATTR_VALUE="MODE_ATTR_VALUE",TreeConstructor.MODE_IN_ARRAY="MODE_IN_ARRAY",TreeConstructor.MODE_IN_EXPR="MODE_IN_EXPR",TreeConstructor.prototype={reset:function(){this.mode=TreeConstructor.MODE_INITIAL,this.nodeStack=[],this.modeStack=[],this.pushNode(this.parser.document)},handleToken:function(a){if(void 0===this.mode)throw new Error("The tree constructor's mode cannot be undefined");if(!a)throw new Error("Token must be provided");if("object"!=typeof a)throw new Error("Token must be an object");if(void 0===a.type)throw new Error("Token type cannot be undefined");if(this.parser.document.debug&&this.parser.debug(this.mode+".handleToken("+a.type+")"),void 0===mode[this.mode])throw new Error("Unknown tree constructor mode: "+this.mode);mode[this.mode](this,a)},setMode:function(a){if(void 0===a)throw new Error("Cannot set undefined mode");this.mode=a},pushMode:function(a){if(void 0===a)throw new Error("cannot push undefined mode");this.modeStack.push(this.mode),this.mode=a},popMode:function(){if(!this.modeStack.length)throw new Error("The mode stack is already empty");if(this.mode=this.modeStack.pop(),void 0===this.mode)throw new Error("cannot pop undefined mode")},pushNode:function(a){this.nodeStack.push(a),this.node=a},popNode:function(){if(!this.nodeStack.length)throw new Error("The node stack is already empty");var a=this.nodeStack.pop();return this.node=this.nodeStack[this.nodeStack.length-1],a},insertElement:function(a){var b=this.parser.document.createElement(a);return this.node.appendChild(b),this.pushNode(b),b},insertChar:function(a){var b=this.parser.document.createText(a);return this.node.lastChild&&transclusion.Node.NODE_TEXT===this.node.lastChild.type?this.node.lastChild.appendData(a):this.node.appendChild(b),CharTester.isWhiteSpace(a)||(this.node.lastChild.whiteSpace=!1),b},insertComment:function(a){var b=this.parser.document.createComment(a);return this.node.appendChild(b),b},insertAttr:function(a){var b=this.parser.document.createAttr(a);return this.node.appendAttr(b),this.pushNode(b),b},insertMetaAttr:function(a){var b=this.parser.document.createAttr(a);return this.node.appendMetaAttr(b),this.pushNode(b),b},insertArray:function(a){var b=this.parser.document.createArray(a);return this.node.appendChild(b),this.pushNode(b),b},insertString:function(a){var b=this.parser.document.createString(a);return this.node.appendChild(b),b},insertNumber:function(a){var b=this.parser.document.createNumber(a);return this.node.appendChild(b),b},insertExpr:function(){var a=this.parser.document.createExpr();return this.node.appendChild(a),this.pushNode(a),a},insertVar:function(a){var b=this.parser.document.createVar(a);return this.node.appendChild(b),b},insertOperator:function(a){var b=this.parser.document.createOperator(a);return this.node.appendChild(b),b},assertTitleElementExists:function(){this.parser.document.titleElement||(this.insertElement("title"),this.popNode())}},mode[TreeConstructor.MODE_INITIAL]=function(a,b){switch(!0){case Token.COMMENT===b.type||Token.CHAR&&CharTester.isWhiteSpace(b.data):break;case Token.DOCTYPE===b.type:a.parser.report("debug","Insert <!DOCTYPE "+b.name+"> (MODE_INITIAL)"),a.insertDoctype(b.name),a.setMode(TreeConstructor.MODE_BEFORE_HTML);break;default:a.parser.report("debug","Force insert <!DOCTYPE html> (MODE_INITIAL)"),a.setMode(TreeConstructor.MODE_BEFORE_HTML),a.handleToken(b)}},mode[TreeConstructor.MODE_BEFORE_HTML]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.START_TAG===b.type:"html"===b.name?(a.parser.report("debug","Inserting <html> (MODE_BEFORE_HTML)"),a.insertElement("html"),a.pushMode(TreeConstructor.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <html> before attempting to insert <"+b.name+"> (MODE_BEFORE_HTML)"),a.insertElement("html"),a.setMode(TreeConstructor.MODE_BEFORE_HEAD),a.handleToken(b));break;case Token.START_TAG_CLOSE===b.type:a.setMode(TreeConstructor.MODE_BEFORE_HEAD),a.node.setInnerStartOffset(b.offset);break;case Token.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <html> before proceeding to handle token: "+b.type+" (MODE_BEFORE_HTML)"),a.insertElement("html"),a.setMode(TreeConstructor.MODE_BEFORE_HEAD),a.handleToken(b)}},mode[TreeConstructor.MODE_BEFORE_HEAD]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.START_TAG===b.type:"head"===b.name?(a.parser.report("debug","Inserting <head> (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.node.setOuterStartOffset(b.offset),a.setMode(TreeConstructor.MODE_IN_HEAD),a.pushMode(TreeConstructor.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <head> before attempting to insert <"+b.name+"> (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.setMode(TreeConstructor.MODE_IN_HEAD),a.handleToken(b));break;case Token.START_TAG_CLOSE===b.type:a.node.setInnerStartOffset(b.offset),a.setMode(TreeConstructor.MODE_IN_HEAD);break;case Token.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <head> before proceeding to handle token: "+b.type+" (MODE_BEFORE_HEAD)"),a.insertElement("head"),a.setMode(TreeConstructor.MODE_IN_HEAD),a.handleToken(b)}},mode[TreeConstructor.MODE_IN_HEAD]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.END_TAG===b.type:"head"===b.name?(a.parser.report("debug","Inserting </head> (MODE_IN_HEAD)"),a.setMode(TreeConstructor.MODE_AFTER_HEAD),a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode()):a.parser.report("exception","Unexpected end tag: </"+b.name+">");break;case Token.START_TAG===b.type:if(a.node.mayContain(b.name))a.insertElement(b.name),a.node.setOuterStartOffset(b.offset),a.pushMode(TreeConstructor.MODE_IN_START_TAG);else{a.parser.report("debug","Inserting </head> before attempting to insert <"+b.name+"> (MODE_IN_HEAD)");while("head"!==a.node.name)a.popNode();a.popNode(),a.setMode(TreeConstructor.MODE_AFTER_HEAD),a.handleToken(b)}break;case Token.START_TAG_CLOSE===b.type:a.parser.report("debug","End start tag: <"+a.node.name+"> (MODE_IN_HEAD)"),a.node.setInnerStartOffset(b.offset),-1<["title","script","style"].indexOf(a.node.name)?(a.pushMode(TreeConstructor.MODE_IN_TEXT),a.parser.tokenizer.setState(transclusion.Tokenizer.STATE_RAWTEXT)):a.node.isVoidElement()&&a.popNode();break;case Token.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting </head> before continuing to process token: "+b.type+" (MODE_IN_HEAD)");while("head"!==a.node.name)a.popNode();a.assertTitleElementExists(),a.popNode(),a.setMode(TreeConstructor.MODE_AFTER_HEAD),a.handleToken(b)}},mode[TreeConstructor.MODE_AFTER_HEAD]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.START_TAG===b.type:"body"===b.name?(a.parser.report("debug","Inserting <body> (MODE_AFTER_HEAD)"),a.insertElement("body"),a.node.setOuterStartOffset(b.offset),a.setMode(TreeConstructor.MODE_IN_BODY),a.pushMode(TreeConstructor.MODE_IN_START_TAG)):(a.parser.report("debug","Inserting <body> before attempting to insert <"+b.name+"> (MODE_AFTER_HEAD)"),a.insertElement("body"),a.setMode(TreeConstructor.MODE_IN_BODY),a.handleToken(b));break;case Token.COMMENT===b.type:a.insertComment(b.data);break;default:a.parser.report("debug","Inserting <body> before proceeding to handle token: "+b.type+" (MODE_AFTER_HEAD)"),a.insertElement("body"),a.setMode(TreeConstructor.MODE_IN_BODY),a.handleToken(b)}},mode[TreeConstructor.MODE_IN_BODY]=function(a,b){switch(!0){case Token.CHAR===b.type:a.insertChar(b.data);break;case Token.START_TAG===b.type:a.node.mayContain(b.name)?(a.parser.report("debug","Inserting <"+b.name+"> (MODE_IN_BODY)"),a.insertElement(b.name),a.node.setOuterStartOffset(b.offset),a.pushMode(TreeConstructor.MODE_IN_START_TAG)):a.parser.report("exception","Unexpected start tag in "+a.node.name+": "+b.name+" (MODE_IN_BODY)");break;case Token.START_TAG_CLOSE===b.type:(a.node.isVoidElement()||b.selfClosing)&&(a.parser.report("debug","Self-closing <"+a.node.name+">"),a.popNode()),a.node.setInnerStartOffset(b.offset);break;case Token.END_TAG===b.type:switch(b.name){case"body":case"html":while("body"!==a.node.name)a.parser.report("debug","Inserting </"+a.node.name+"> (MODE_IN_BODY)"),a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode();a.parser.report("debug","Inserting </body> (MODE_IN_BODY)"),a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode(),a.setMode(TreeConstructor.MODE_AFTER_BODY),"html"===b.name&&a.handleToken(b);break;default:b.name===a.node.name?(a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode()):a.parser.report("exception","Unexpected end tag </"+b.name+"> in <"+a.node.name+"> (MODE_IN_BODY)")}break;case Token.EOF===b.type:a.parser.report("debug","Inserting </body> at end of file (MODE_IN_BODY)");while("body"!==a.node.name)a.popNode();a.setMode(TreeConstructor.MODE_AFTER_BODY),a.handleToken(b);break;case Token.COMMENT===b.type:a.insertComment(b.data);break;case Token.START_EXPR===b.type:a.insertExpr(),a.pushMode(TreeConstructor.MODE_IN_EXPR);break;default:a.parser.report("exception","Unexpected token: "+b.type+" (MODE_IN_BODY)")}},mode[TreeConstructor.MODE_AFTER_BODY]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.EOF===b.type:a.parser.report("debug","Inserting </html> at end of file (MODE_AFTER_BODY)");while("html"!==a.node.name)a.popNode();a.setMode(TreeConstructor.MODE_AFTER_HTML),a.handleToken(b);break;case Token.END_TAG===b.type:if("html"===b.name){while("html"!==a.node.name)a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode();a.node.setInnerEndOffset(b.innerOffset),a.node.setOuterEndOffset(b.outerOffset),a.popNode(),a.setMode(TreeConstructor.MODE_AFTER_HTML)}else a.parser.report("exception","Unexpected end tag </"+b.name+"> (MODE_AFTER_BODY)");break;case Token.COMMENT===b.type:a.insertComment(b.data);break;case Token.START_TAG===b.type:a.parser.report("error","Unexpected start tag <"+b.name+"> after body (MODE_AFTER_BODY)"),a.setMode(TreeConstructor.MODE_IN_BODY),a.pushNode(a.parser.document.bodyElement),a.handleToken(b);break;default:a.parser.report("exception","Unexpected token after body: "+b.type+" (MODE_AFTER_BODY)"),a.setMode(TreeConstructor.MODE_IN_BODY),a.pushNode(a.parser.document.bodyElement),a.handleToken(b)}},mode[TreeConstructor.MODE_IN_START_TAG]=function(a,b){switch(!0){case Token.START_TAG_CLOSE===b.type:a.popMode(),transclusion.Node.NODE_ATTR===a.node.type&&a.popNode(),a.handleToken(b);break;case Token.START_ARR===b.type:a.insertArray(),a.pushMode(TreeConstructor.MODE_IN_ARRAY);break;case Token.START_OBJ===b.type:a.insertObject(),a.pushMode(TreeConstructor.MODE_OBJ);break;case Token.ATTR_KEY===b.type:while(transclusion.Node.NODE_ATTR===a.node.type)a.popNode();a.node.mayContainMetaAttribute(b.name)?a.insertMetaAttr(b.name):a.insertAttr(a.node.mayContainAttribute(b.name)?b.name:"data-"+b.name);break;case Token.START_ATTR_VALUE===b.type:a.pushMode(TreeConstructor.MODE_ATTR_VALUE);break;default:a.parser.report("exception","Unexpected token in start tag mode: ".tok.type)}},mode[TreeConstructor.MODE_AFTER_HTML]=function(a,b){switch(!0){case Token.CHAR===b.type&&CharTester.isWhiteSpace(b.data):a.insertChar(b.data);break;case Token.COMMENT===b.type:a.insertComment(b.data);break;case Token.EOF===b.type:break;default:a.parser.report("exception","Unexpected token after html: "+b.type)}},mode[TreeConstructor.MODE_IN_TEXT]=function(a,b){switch(!0){case Token.CHAR===b.type:a.insertChar(b.data);break;case Token.EOF===b.type:a.parser.report("error","Unexpected end of file in text mode (MODE_IN_TEXT)"),"script"===a.node&&(a.node.alreadyStarted=!0),a.popNode(),a.popMode(),a.handleToken(b);break;case Token.END_TAG===b.type:a.popNode(),a.popMode()}},mode[TreeConstructor.MODE_ATTR_VALUE]=function(a,b){switch(!0){case Token.CHAR===b.type:a.insertChar(b.data);break;case Token.END_ATTR_VALUE===b.type:a.popMode(),a.popNode();break;case Token.EOF===b.type:a.parser.report("error","Unexpected token in attribute value: "+b.type+" (MODE_ATTR_VALUE)");break;default:a.parser.report("exception","Unexpected token: "+b.type+" (MODE_ATTR_VALUE)")}},mode[TreeConstructor.MODE_IN_ARRAY]=function(a,b){switch(!0){case Token.STR===b.type:a.insertString(b.data);break;case Token.END_ARR===b.type:a.popMode(),a.popNode();break;default:a.parser.report("exception","Unexpected token: "+b.type+" (MODE_IN_ARRAY)")}},mode[TreeConstructor.MODE_IN_EXPR]=function(a,b){switch(!0){case Token.EOF===b.type:a.popMode();break;case Token.VAR===b.type:a.insertVar(b.name);break;case Token.STR===b.type:a.insertString(b.data);break;case Token.NUM===b.type:a.insertNumber(b.value);break;case Token.OPERATOR===b.type:a.insertOperator(b.sign);break;case Token.START_EXPR===b.type:a.insertExpr(),a.pushMode(TreeConstructor.MODE_IN_EXPR);break;case Token.END_EXPR===b.type:a.popMode(),a.popNode();break;default:a.parser.report("exception","Unexpected token: "+b.type+" (MODE_IN_EXPR)")}};function Parser(a){if(!a)throw new Error("Missing `document` for Parser");this.document=a,this.treeConstructor=null,this.tokenizer=null,this.messages=[]}transclusion.Parser=Parser,Parser.prototype={reset:function(){this.treeConstructor&&this.treeConstructor.reset(),this.tokenizer&&this.tokenizer.reset(),this.messages=[]},parse:function(a){this.getTokenizer().tokenize(a)},handleToken:function(a){this.getTreeConstructor().handleToken(a)},getTokenizer:function(){return null===this.tokenizer&&(this.tokenizer=new transclusion.Tokenizer(this)),this.tokenizer},getTreeConstructor:function(){return null===this.treeConstructor&&(this.treeConstructor=new transclusion.TreeConstructor(this)),this.treeConstructor},report:function(a,b){if("exception"===a)throw new Error(b);"notice"===a?console.warn(">> Parser.NOTICE",b):"error"===a&&console.error(">> Parser.ERROR",b),this.messages.push({type:a,message:b})},debug:function(){var a,b,c;for(a=0,b=arguments.length;b>a;a++){if(c=arguments[a],"object"==typeof c)throw new Error("Can't debug objects (yet)");this.report("debug",c)}}};function Compiler(a){if(!a)throw new Error("Missing `document` for Compiler");this.document=a}return transclusion.Compiler=Compiler,Compiler.prototype={compile:function(){return this.compileNodes(this.document.childNodes)},compileNodes:function(a){var b,c,d="";for(b=0,c=a.length;c>b;b++)d+=this.compileNode(a[b]);return d},compileNode:function(a){var b="";switch(a.type){case transclusion.Node.NODE_ELEMENT:b+="<",b+=a.name,b+=this.compileNodes(a.attrs),b+=">",a.isVoidElement()||(b+=this.compileNodes(a.childNodes),b+="</",b+=a.name,b+=">");break;case transclusion.Node.NODE_TEXT:b+=a.data;break;case transclusion.Node.NODE_COMMENT:b+="<!--",b+=a.data,b+="-->";break;case transclusion.Node.NODE_ATTR:b+=" ",b+=a.name,b+='="',b+=this.compileNodes(a.childNodes),b+='"';break;case transclusion.Node.NODE_ARRAY:b+="Array("+a.childNodes.length+")";break;case transclusion.Node.NODE_EXPR:a.childNodes.length&&(b+=this.compileExpr(a));break;case transclusion.Node.NODE_VAR:b+="this.document.context."+a.name;break;case transclusion.Node.NODE_OPERATOR:b+=" ",b+=a.sign,b+=" ";break;case transclusion.Node.NODE_NUMBER:b+=a.value;break;case transclusion.Node.NODE_STRING:b+="'"+a.data.replace(/(\')/gm,"\\'")+"'";break;default:throw new Error("Unsupported node type in compiler: "+a.type)}return b},compileExpr:function(node){var ret="";return transclusion.NODE_EXPR===node.parentNode.type,ret+=this.compileNodes(node.childNodes),transclusion.NODE_EXPR===node.parentNode.type,console.log(ret),eval(ret)}},transclusion});
//# sourceMappingURL=transclusion.min.js.map